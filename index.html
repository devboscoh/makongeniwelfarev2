<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Makongeni Green Nairobi Welfare</title>

    <!-- Simplified Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%2328a745'/%3E%3Cpath fill='white' d='M50 20c-10 0-15 8-20 15-5-7-10-15-20-15 0 20 15 35 20 45 5-10 20-25 20-45zm0 0c10 0 15 8 20 15 5-7 10-15 20-15 0 20-15 35-20 45-5-10-20-25-20-45z'/%3E%3Crect x='45' y='65' width='10' height='20' fill='white' rx='2'/%3E%3C/svg%3E" />

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Modern Color Palette */
            --primary: #0A2540;       /* Deep Navy Blue */
            --secondary: #28a745;     /* Green */
            --accent: #FFD700;        /* Gold */
            --light: #F8F9FA;         /* Light Gray */
            --dark: #212529;          /* Dark Gray */
            --muted: #6C757D;         /* Muted Gray */
            
            /* Functional Colors */
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            
            /* Modern Spacing */
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;
            
            /* Modern Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* Smooth Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;
            
            /* Modern Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.16);
        }
    
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            font-size: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    
        /* ========== TYPOGRAPHY ========== */
        h1, h2, h3, h4, h5, h6 {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: var(--space-md);
            letter-spacing: -0.025em;
        }
    
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-xl);
            line-height: 1.2;
        }
    
        h2 {
            font-size: 2rem;
            margin-bottom: var(--space-xl);
            position: relative;
            display: inline-block;
        }
    
        h2:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            border-radius: 2px;
        }
    
        h3 {
            font-size: 1.5rem;
            color: var(--dark);
        }
    
        .text-accent { color: var(--accent) !important; }
        .text-secondary { color: var(--secondary) !important; }
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-muted { color: var(--muted) !important; }
    
        /* ========== NAVBAR ========== */
        .navbar {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            height: 72px;
            box-shadow: var(--shadow-lg);
            padding: 0 var(--space-xl);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    
        .navbar-brand {
            font-weight: 800;
            font-size: 1.5rem;
            color: white !important;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: var(--space-sm) 0;
        }
    
        .navbar-brand::before {
            content: "ðŸŒ¿";
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
    
        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            padding: var(--space-sm) var(--space-md) !important;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            position: relative;
        }
    
        .nav-link:hover {
            color: white !important;
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
    
        .nav-link.active {
            color: var(--accent) !important;
            background: rgba(255, 215, 0, 0.15);
            font-weight: 600;
        }
    
        /* ========== CARDS ========== */
        .card {
            background: white;
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            overflow: hidden;
            margin-bottom: var(--space-lg);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
    
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-6px);
            border-color: rgba(var(--secondary-rgb), 0.2);
        }
    
        .card-header {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            color: white;
            border: none;
            padding: var(--space-xl);
            font-weight: 600;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }
    
        .card-body {
            padding: var(--space-xl);
        }
    
        /* ========== DASHBOARD CARDS ========== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }
    
        .dashboard-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            height: 100%;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
    
        .dashboard-card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-8px) scale(1.02);
            border-color: var(--secondary);
        }
    
        .dashboard-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            opacity: 0;
            transition: opacity var(--transition-base);
        }
    
        .dashboard-card:hover:before {
            opacity: 1;
        }
    
        .dashboard-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--secondary), #34ce57);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
            color: white;
            font-size: 2rem;
            transition: all var(--transition-base);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.2);
        }
    
        .dashboard-card:hover .dashboard-icon {
            transform: scale(1.15) rotate(10deg);
            background: linear-gradient(135deg, var(--accent), #ffed4e);
            box-shadow: 0 12px 24px rgba(255, 215, 0, 0.3);
        }
    
        /* ========== BUTTONS ========== */
        .btn {
            border-radius: var(--radius-md);
            font-weight: 600;
            padding: var(--space-md) var(--space-xl);
            border: none;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }
    
        .btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
    
        .btn:hover:after {
            width: 300px;
            height: 300px;
        }
    
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #34ce57);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
    
        .btn-primary:hover {
            background: linear-gradient(135deg, #34ce57, var(--secondary));
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.3);
        }
    
        .btn-secondary {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            color: white;
            box-shadow: 0 4px 12px rgba(10, 37, 64, 0.2);
        }
    
        .btn-secondary:hover {
            background: linear-gradient(135deg, #0d3b66, var(--primary));
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(10, 37, 64, 0.3);
        }
    
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }
    
        .btn-outline:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-3px);
        }
    
        /* ========== TABLES ========== */
        .table {
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
    
        .table thead {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
        }
    
        .table thead th {
            color: white !important;
            padding: var(--space-lg);
            font-weight: 600;
            border: none;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }
    
        .table tbody td {
            padding: var(--space-lg);
            border-color: rgba(0, 0, 0, 0.05);
            vertical-align: middle;
        }
    
        .table tbody tr {
            transition: all var(--transition-fast);
        }
    
        .table tbody tr:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(4px);
        }
    
        /* ========== FORMS ========== */
        .form-control, .form-select {
            border-radius: var(--radius-md);
            padding: var(--space-md) var(--space-lg);
            border: 2px solid #e9ecef;
            transition: all var(--transition-fast);
            font-size: 0.95rem;
            background: white;
        }
    
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.15);
            transform: translateY(-1px);
        }
    
        .form-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-sm);
            font-size: 0.95rem;
        }
    
        /* ========== ALERTS ========== */
        .alert {
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border: none;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
    
        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 4px solid var(--success);
        }
    
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-left: 4px solid var(--danger);
        }
    
        /* ========== BADGES ========== */
        .badge {
            padding: var(--space-sm) var(--space-md);
            font-weight: 600;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            letter-spacing: 0.3px;
        }
    
        .badge-success {
            background: linear-gradient(135deg, var(--success), #34ce57);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }
    
        .badge-primary {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            color: white;
            box-shadow: 0 2px 8px rgba(10, 37, 64, 0.2);
        }
    
        /* ========== LOADING ========== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-3xl);
            min-height: 300px;
        }
    
        .loading::after {
            content: "";
            width: 48px;
            height: 48px;
            border: 3px solid rgba(40, 167, 69, 0.1);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    
        /* ========== MODAL ========== */
        .modal-content {
            border: none;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
    
        .modal-header {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            color: white;
            border: none;
            padding: var(--space-xl);
        }
    
        .modal-body {
            padding: var(--space-xl);
        }
    
        /* ========== SECTION TITLES ========== */
        .section-title {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-md);
            position: relative;
            font-size: 1.5rem;
        }
    
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            border-radius: 2px;
        }
    
        /* ========== SUMMARY CARDS ========== */
        .summary-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border-left: 5px solid var(--secondary);
            margin-bottom: var(--space-lg);
            position: relative;
            overflow: hidden;
        }
    
        .summary-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }
    
        .summary-card .amount {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1.2;
            margin: var(--space-sm) 0;
        }
    
        .summary-card .subtitle {
            color: var(--muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--space-xs);
        }
    
        /* ========== LOGIN PAGE ========== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            padding: var(--space-xl);
            position: relative;
            overflow: hidden;
        }
    
        .login-container:before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 20s infinite linear;
        }
    
        .login-card {
            width: 100%;
            max-width: 480px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            animation: fadeIn 0.6s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
    
        .login-header {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            padding: var(--space-2xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
    
        .login-header:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
    
        .login-header h2 {
            color: white;
            background: none;
            -webkit-text-fill-color: white;
            position: relative;
            z-index: 1;
        }
    
        .login-body {
            padding: var(--space-2xl);
        }
    
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    
        @keyframes pulse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    
        /* ========== MAIN CONTAINER ========== */
        .main-container {
            padding: var(--space-2xl);
            max-width: 1400px;
            margin: 0 auto;
            animation: slideUp 0.5s ease;
        }
    
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
        /* ========== USER WELCOME ========== */
        .user-welcome {
            background: linear-gradient(135deg, var(--primary), #0d3b66);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-2xl);
            color: white;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
    
        .user-welcome:before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
    
        .user-welcome h4 {
            color: white;
            background: none;
            -webkit-text-fill-color: white;
            font-size: 1.5rem;
            position: relative;
            z-index: 1;
        }
    
        .user-welcome p {
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }
    
        /* ========== YEAR SELECTOR ========== */
        .year-selector {
            margin-bottom: var(--space-2xl);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            max-width: 300px;
        }
        
        .year-selector label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0;
            font-size: 1rem;
        }
        
        .year-selector .form-select {
            flex: 1;
            min-width: 120px;
            background: var(--light);
            border: 2px solid rgba(0, 0, 0, 0.08);
        }
    
        .year-selector .form-select:focus {
            border-color: var(--secondary);
            background: white;
        }
    
        /* ========== ACTION BUTTONS ========== */
        .action-buttons {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
            margin-top: var(--space-xl);
        }
    
        /* ========== STATUS INDICATORS ========== */
        .status-active {
            color: var(--success);
            font-weight: 600;
        }
    
        .status-inactive {
            color: var(--muted);
        }
    
        .status-positive {
            color: var(--success);
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .status-negative {
            color: var(--danger);
            font-weight: 700;
            font-size: 1.1em;
        }
    
        /* ========== PROGRESS BARS ========== */
        .progress {
            height: 12px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-full);
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    
        .progress-bar {
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            border-radius: var(--radius-full);
            transition: width 1s ease;
        }
    
        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 10px;
        }
    
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: var(--radius-sm);
        }
    
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border-radius: var(--radius-sm);
        }
    
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #34ce57, var(--accent));
        }
    
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .navbar { padding: 0 var(--space-md); height: 64px; }
            .navbar-brand { font-size: 1.3rem; }
            .main-container { padding: var(--space-lg); }
            .card-body { padding: var(--space-lg); }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.6rem; }
            .dashboard-icon { width: 70px; height: 70px; font-size: 1.8rem; }
            .summary-card .amount { font-size: 2rem; }
        }
    
        @media (max-width: 480px) {
            :root {
                --space-lg: 1rem;
                --space-xl: 1.25rem;
                --space-2xl: 2rem;
            }
            .btn { padding: var(--space-sm) var(--space-lg); }
            .card-body { padding: var(--space-md); }
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }
        }
    
        /* ========== UTILITY CLASSES ========== */
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    
        .shadow-hover {
            transition: box-shadow var(--transition-base);
        }
    
        .shadow-hover:hover {
            box-shadow: var(--shadow-xl);
        }
    
        .hover-lift {
            transition: transform var(--transition-base);
        }
    
        .hover-lift:hover {
            transform: translateY(-4px);
        }
    
        /* ========== ANIMATIONS ========== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
        .animate-fadeInUp {
            animation: fadeInUp 0.5s ease;
        }
    
        /* ========== GRID LAYOUTS ========== */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }
    
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
        }
    
        /* ========== SEPARATOR ========== */
        .separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);
            margin: var(--space-2xl) 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React + Babel -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- SHA256 for password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.10.1/src/sha256.min.js"></script>
    <!-- XLSX for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK (Modular Imports) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager, collection, getDocs, setDoc, addDoc, deleteDoc, query, where, writeBatch, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        window.firebase = { initializeApp, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, getAuth, collection, getDocs, setDoc, addDoc, deleteDoc, query, where, writeBatch, doc, updateDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBNoBB70RfLwSAKYglQ19IOOCR8jfwhw_w",
            authDomain: "makongeniwelfare-89ff4.firebaseapp.com",
            projectId: "makongeniwelfare-89ff4",
            storageBucket: "makongeniwelfare-89ff4.firebasestorage.app",
            messagingSenderId: "274417711955",
            appId: "1:274417711955:web:64be8b0c2584bf174fffa6",
            measurementId: "G-ZLQ0H5EYSL"
        };

        // Global database instance
        let db = null;
        let isFirebaseInitialized = false;
        let initializationPromise = null;

        // Initialize Firebase with retry logic
        const initializeFirebase = async () => {
            if (isFirebaseInitialized) return true;
            if (initializationPromise) return initializationPromise;
            initializationPromise = (async () => {
                try {
                    if (!firebaseConfig.apiKey) throw new Error("Firebase configuration is missing or invalid.");
                    const app = firebase.initializeApp(firebaseConfig);
                    db = firebase.initializeFirestore(app, {
                        localCache: firebase.persistentLocalCache({
                            tabManager: firebase.persistentMultipleTabManager()
                        })
                    });
                    isFirebaseInitialized = true;
                    console.log("Firebase initialized successfully");
                    return true;
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    isFirebaseInitialized = false;
                    initializationPromise = null;
                    return false;
                }
            })();
            return initializationPromise;
        };

        // Month names
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Years from 2024 to 2030
        const YEARS = Array.from({length: 7}, (_, i) => 2024 + i);

        // Firestore helpers
        const loadData = async (collectionName, defaultValue = []) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const collRef = firebase.collection(db, collectionName);
                const snapshot = await firebase.getDocs(collRef);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) {
                console.error(`Error loading ${collectionName}:`, e);
                return defaultValue;
            }
        };

        const saveData = async (collectionName, data) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const batch = firebase.writeBatch(db);
                data.forEach(item => {
                    const docRef = firebase.doc(firebase.collection(db, collectionName));
                    batch.set(docRef, item);
                });
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error saving ${collectionName}:`, e);
                throw e;
            }
        };

        const addData = async (collectionName, item) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                await firebase.addDoc(firebase.collection(db, collectionName), item);
                return true;
            } catch (e) {
                console.error(`Error adding to ${collectionName}:`, e);
                throw e;
            }
        };

        const updateData = async (collectionName, id, updates) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const docRef = firebase.doc(db, collectionName, id);
                await firebase.updateDoc(docRef, updates);
                return true;
            } catch (e) {
                console.error(`Error updating in ${collectionName}:`, e);
                throw e;
            }
        };

        const deleteData = async (collectionName, queryField, queryValue) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const collRef = firebase.collection(db, collectionName);
                const q = firebase.query(collRef, firebase.where(queryField, '==', queryValue));
                const snapshot = await firebase.getDocs(q);
                const batch = firebase.writeBatch(db);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error deleting from ${collectionName}:`, e);
                throw e;
            }
        };

        const deleteByIds = async (collectionName, ids) => {
            try {
                if (!db) {
                    const initialized = await initializeFirebase();
                    if (!initialized) throw new Error("Database not initialized");
                }
                const batch = firebase.writeBatch(db);
                ids.forEach(id => {
                    const docRef = firebase.doc(firebase.collection(db, collectionName), id);
                    batch.delete(docRef);
                });
                await batch.commit();
                return true;
            } catch (e) {
                console.error(`Error deleting from ${collectionName}:`, e);
                throw e;
            }
        };

        // Utils for date parsing
        const getYear = (date) => {
            if (!date) return 0;
            if (typeof date === 'string') {
                return parseInt(date.split('-')[0], 10);
            }
            return date.getFullYear();
        };

        const getMonth = (date) => {
            if (!date) return 0;
            if (typeof date === 'string') {
                return parseInt(date.split('-')[1], 10);
            }
            return date.getMonth() + 1;
        };

        // Compute member shares from earnings
        const computeGroupShare = async (year) => {
            try {
                const [payments, loans, members] = await Promise.all([
                    loadData('payments', []),
                    loadData('loans', []),
                    loadData('users', [])
                ]);
                
                if (members.length === 0) return {};

                // Filter payments for the specific year
                const yearPayments = payments.filter(p => getYear(p.date) === year);
                const monthlySums = {};
                const contributingMonths = {};

                // Initialize contributing months for each member
                members.forEach(member => {
                    contributingMonths[member.name] = 0;
                });

                // Calculate total payments per member per month
                yearPayments.forEach(p => {
                    const month = getMonth(p.date);
                    if (month >= 1 && month <= 12) {
                        const key = `${year}-${month}-${p.member}`;
                        monthlySums[key] = (monthlySums[key] || 0) + (parseFloat(p.paidIn) || 0);
                    }
                });

                let totalFines = 0;

                // Calculate fines and contributing months for each member
                members.forEach(member => {
                    for (let month = 1; month <= 12; month++) {
                        const key = `${year}-${month}-${member.name}`;
                        const monthTotal = monthlySums[key] || 0;
                        if (monthTotal < 300) {
                            totalFines += 50;
                        } else if (monthTotal >= 300) {
                            contributingMonths[member.name] += 1;
                        }
                    }
                });

                // Calculate total contributing months across all members
                const totalContributingMonths = Object.values(contributingMonths).reduce((sum, count) => sum + count, 0);

                // Calculate loans and interest for the specific year
                const totalLoans = loans
                    .filter(l => getYear(l.date) === year)
                    .reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const totalInterest = totalLoans * 0.1;

                // Calculate total profit
                const totalProfit = totalFines + totalInterest;

                // Calculate shares proportionally
                const shares = {};
                members.forEach(member => {
                    if (totalContributingMonths > 0) {
                        const proportion = contributingMonths[member.name] / totalContributingMonths;
                        shares[member.name] = totalProfit * proportion;
                    } else {
                        shares[member.name] = 0;
                    }
                });

                return shares;
            } catch (e) {
                console.error("Error computing member shares:", e);
                const members = await loadData('users', []);
                return members.reduce((acc, member) => ({ ...acc, [member.name]: 0 }), {});
            }
        };

        // Helper function to calculate member fines correctly
        const calculateMemberFines = (memberName, payments, year) => {
            const monthlyTotals = {};
            
            payments
                .filter(p => p.member === memberName && getYear(p.date) === year)
                .forEach(p => {
                    const month = getMonth(p.date);
                    if (month >= 1 && month <= 12) {
                        monthlyTotals[month] = (monthlyTotals[month] || 0) + (parseFloat(p.paidIn) || 0);
                    }
                });
            
            let totalFines = 0;
            for (let month = 1; month <= 12; month++) {
                const monthTotal = monthlyTotals[month] || 0;
                if (monthTotal < 300) {
                    totalFines += 50;
                }
            }
            
            return totalFines;
        };

        // ErrorBoundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorMessage: '' };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, errorMessage: error.message };
            }
            componentDidCatch(error, info) {
                console.error('ErrorBoundary caught', error, info);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="card">
                            <div className="card-body">
                                <div className="alert alert-danger">
                                    <h5>Something went wrong</h5>
                                    <p>{this.state.errorMessage}</p>
                                    <button 
                                        className="btn btn-primary mt-3" 
                                        onClick={() => window.location.reload()}
                                    >
                                        Reload Application
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // DatabaseInitializer
        function DatabaseInitializer({ children }) {
            const [isInitialized, setIsInitialized] = useState(false);
            const [error, setError] = useState('');
            const [retryCount, setRetryCount] = useState(0);
            const maxRetries = 3;
            
            useEffect(() => {
                const init = async () => {
                    try {
                        const success = await initializeFirebase();
                        if (success) {
                            setIsInitialized(true);
                        } else {
                            throw new Error("Failed to initialize Firebase.");
                        }
                    } catch (e) {
                        if (retryCount < maxRetries) {
                            setTimeout(() => setRetryCount(retryCount + 1), 2000);
                        } else {
                            setError(`Initialization failed after ${maxRetries} attempts: ${e.message}`);
                        }
                    }
                };
                init();
            }, [retryCount]);
            
            if (error) {
                return (
                    <div className="login-container">
                        <div className="card" style={{ maxWidth: '500px' }}>
                            <div className="card-body text-center">
                                <h3 className="text-danger mb-4">Application Initialization Error</h3>
                                <p className="text-muted mb-4">{error}</p>
                                <div className="d-flex gap-3 justify-content-center">
                                    <button className="btn btn-primary" onClick={() => { setRetryCount(0); setError(''); }}>
                                        <i className="bi bi-arrow-clockwise me-2"></i>
                                        Retry Connection
                                    </button>
                                    <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                                        <i className="bi bi-arrow-repeat me-2"></i>
                                        Refresh Page
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (!isInitialized) {
                return (
                    <div className="login-container">
                        <div className="text-center text-white">
                            <div className="loading mb-4"></div>
                            <h4 className="mb-2">Initializing Application</h4>
                            <p className="text-light">Attempt {retryCount + 1} of {maxRetries}</p>
                        </div>
                    </div>
                );
            }
            
            return children;
        }

        // Login Component
        function Login({ onLogin }) {
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const users = await loadData('users', []);
                    const hashed = sha256(password || '');
                    const user = users.find(u => u.name === name && u.password === hashed);
                    if (user) {
                        onLogin(user);
                    } else {
                        setError('Invalid username or password');
                        setTimeout(() => setError(''), 3000);
                    }
                } catch (e) {
                    setError('Error logging in: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <ErrorBoundary>
                    <div className="login-container">
                        <div className="login-card">
                            <div className="login-header">
                                <h2>Welcome Back</h2>
                                <p className="text-light mb-0">Makongeni Green Nairobi Welfare</p>
                            </div>
                            <div className="login-body">
                                <h2 className="card-title text-center mb-4">Login to Dashboard</h2>
                                {error && (
                                    <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                        {error}
                                        <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                    </div>
                                )}
                                {loading && <div className="loading">Loading...</div>}
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">
                                        <label className="form-label">Username</label>
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            value={name} 
                                            onChange={e => setName(e.target.value)} 
                                            required 
                                            disabled={loading}
                                            placeholder="Enter your username"
                                        />
                                    </div>
                                    <div className="mb-4">
                                        <label className="form-label">Password</label>
                                        <input 
                                            type="password" 
                                            className="form-control" 
                                            value={password} 
                                            onChange={e => setPassword(e.target.value)} 
                                            required 
                                            disabled={loading}
                                            placeholder="Enter your password"
                                        />
                                    </div>
                                    <button type="submit" className="btn btn-primary w-100 py-3" disabled={loading}>
                                        <i className="bi bi-box-arrow-in-right me-2"></i>
                                        {loading ? 'Signing in...' : 'Sign In'}
                                    </button>
                                    <div className="text-center mt-4">
                                        <small className="text-muted">
                                            Contact administrator if you forgot your credentials
                                        </small>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // Dashboard Component
        function Dashboard({ user, onLogout }) {
            const [view, setView] = useState('home');
            const [year, setYear] = useState(new Date().getFullYear());
            const [alert, setAlert] = useState('');
            
            const showAlert = (msg, type = 'success') => {
                setAlert({ msg, type });
                setTimeout(() => setAlert(''), 3000);
            };
            
            const renderView = () => {
                const viewProps = { year, setYear };
                switch (view) {
                    case 'addMember': return user.role === 'Admin' ? <AddMember onSuccess={() => showAlert('Member added successfully')} /> : <AccessDenied />;
                    case 'batchAddMembers': return user.role === 'Admin' ? <BatchAddMembers onSuccess={() => showAlert('Members added successfully')} /> : <AccessDenied />;
                    case 'viewMembers': return user.role === 'Admin' ? <ViewMembers onRemoveSuccess={() => showAlert('Member(s) removed successfully')} onEditSuccess={() => showAlert('Member updated successfully')} /> : <AccessDenied />;
                    case 'addPayment': return ['Admin', 'Secretary'].includes(user.role) ? <AddPayment onSuccess={() => showAlert('Payment recorded successfully')} /> : <AccessDenied />;
                    case 'batchAddPayments': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddPayments onSuccess={() => showAlert('Payments added successfully')} /> : <AccessDenied />;
                    case 'addLoan': return ['Admin', 'Secretary'].includes(user.role) ? <AddLoan onSuccess={() => showAlert('Loan recorded successfully')} /> : <AccessDenied />;
                    case 'batchAddLoans': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddLoans onSuccess={() => showAlert('Loans added successfully')} /> : <AccessDenied />;
                    case 'addExpenditure': return ['Admin', 'Secretary'].includes(user.role) ? <AddExpenditure onSuccess={() => showAlert('Expenditure recorded successfully')} /> : <AccessDenied />;
                    case 'batchAddExpenditures': return ['Admin', 'Secretary'].includes(user.role) ? <BatchAddExpenditures onSuccess={() => showAlert('Expenditures added successfully')} /> : <AccessDenied />;
                    case 'viewAll': return ['Admin', 'Secretary', 'Chairman', 'Treasurer', 'Member'].includes(user.role) ? <ViewAllData {...viewProps} /> : <AccessDenied />;
                    case 'viewPersonal': return <ViewPersonal userId={user.name} {...viewProps} />;
                    case 'download': return user.role === 'Admin' ? <DownloadData year={year} /> : <AccessDenied />;
                    case 'monthlySummary': return ['Admin', 'Secretary', 'Chairman'].includes(user.role) ? <MonthlySummary {...viewProps} /> : <AccessDenied />;
                    case 'uploadData': return user.role === 'Admin' ? <UploadData onSuccess={() => showAlert('Data uploaded successfully')} /> : <AccessDenied />;
                    case 'manageTransactions': return user.role === 'Admin' ? <ManageTransactions year={year} onDeleteSuccess={() => showAlert('Transactions deleted successfully')} onEditSuccess={() => showAlert('Transaction updated successfully')} /> : <AccessDenied />;
                    default: return <Home user={user} setView={setView} />;
                }
            };
            
            return (
                <ErrorBoundary>
                    <div className="animate-fadeInUp">
                        <nav className="navbar navbar-expand-lg">
                            <div className="container-fluid">
                                <a className="navbar-brand" href="#" onClick={(e) => { e.preventDefault(); setView('home'); }}>
                                    Makongeni Green Nairobi Welfare
                                </a>
                                <div className="navbar-nav ms-auto align-items-center">
                                    <div className="nav-item me-3">
                                        <span className="nav-link text-light">
                                            <i className="bi bi-person-circle me-2"></i>
                                            {user.name} <small className="ms-2 opacity-75">({user.role})</small>
                                        </span>
                                    </div>
                                    <div className="nav-item">
                                        <button className="btn btn-outline-light btn-sm" onClick={onLogout}>
                                            <i className="bi bi-box-arrow-right me-1"></i>
                                            Sign Out
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </nav>
                        
                        <div className="main-container">
                            {alert && (
                                <div className={`alert alert-${alert.type} alert-dismissible fade show`}>
                                    {alert.msg}
                                    <button type="button" className="btn-close" onClick={() => setAlert('')}></button>
                                </div>
                            )}
                            
                            <div className="year-selector animate-fadeInUp">
                                <i className="bi bi-calendar3 text-secondary"></i>
                                <label>Financial Year:</label>
                                <select 
                                    className="form-select" 
                                    value={year} 
                                    onChange={e => setYear(parseInt(e.target.value, 10))}
                                >
                                    {YEARS.map(y => (
                                        <option key={y} value={y}>{y}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {renderView()}
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // Home Component
        function Home({ user, setView }) {
            const getDashboardCards = () => {
                const cards = [];
                
                if (user.role === 'Admin') {
                    cards.push(
                        { title: 'Add Member', icon: 'person-plus', view: 'addMember', color: 'success' },
                        { title: 'Batch Add Members', icon: 'people', view: 'batchAddMembers', color: 'primary' },
                        { title: 'View Members', icon: 'person-lines-fill', view: 'viewMembers', color: 'info' },
                        { title: 'Add Payment', icon: 'currency-exchange', view: 'addPayment', color: 'success' },
                        { title: 'Batch Add Payments', icon: 'receipt', view: 'batchAddPayments', color: 'primary' },
                        { title: 'Add Loan', icon: 'bank', view: 'addLoan', color: 'warning' },
                        { title: 'Batch Add Loans', icon: 'credit-card', view: 'batchAddLoans', color: 'info' },
                        { title: 'Add Expenditure', icon: 'wallet', view: 'addExpenditure', color: 'danger' },
                        { title: 'Batch Add Expenditures', icon: 'receipt-cutoff', view: 'batchAddExpenditures', color: 'warning' },
                        { title: 'Manage Transactions', icon: 'pencil-square', view: 'manageTransactions', color: 'secondary' },
                        { title: 'Personal Data', icon: 'person', view: 'viewPersonal', color: 'info' },
                        { title: 'Group Data', icon: 'people-fill', view: 'viewAll', color: 'primary' },
                        { title: 'Monthly Summary', icon: 'calendar-week', view: 'monthlySummary', color: 'success' },
                        { title: 'Upload Data', icon: 'cloud-upload', view: 'uploadData', color: 'info' },
                        { title: 'Download Data', icon: 'cloud-download', view: 'download', color: 'secondary' }
                    );
                } else if (user.role === 'Secretary') {
                    cards.push(
                        { title: 'Add Payment', icon: 'currency-exchange', view: 'addPayment', color: 'success' },
                        { title: 'Batch Add Payments', icon: 'receipt', view: 'batchAddPayments', color: 'primary' },
                        { title: 'Add Loan', icon: 'bank', view: 'addLoan', color: 'warning' },
                        { title: 'Batch Add Loans', icon: 'credit-card', view: 'batchAddLoans', color: 'info' },
                        { title: 'Add Expenditure', icon: 'wallet', view: 'addExpenditure', color: 'danger' },
                        { title: 'Batch Add Expenditures', icon: 'receipt-cutoff', view: 'batchAddExpenditures', color: 'warning' },
                        { title: 'Personal Data', icon: 'person', view: 'viewPersonal', color: 'info' },
                        { title: 'Group Data', icon: 'people-fill', view: 'viewAll', color: 'primary' },
                        { title: 'Monthly Summary', icon: 'calendar-week', view: 'monthlySummary', color: 'success' }
                    );
                } else if (user.role === 'Chairman') {
                    cards.push(
                        { title: 'Personal Data', icon: 'person', view: 'viewPersonal', color: 'info' },
                        { title: 'Group Data', icon: 'people-fill', view: 'viewAll', color: 'primary' },
                        { title: 'Monthly Summary', icon: 'calendar-week', view: 'monthlySummary', color: 'success' }
                    );
                } else if (user.role === 'Treasurer') {
                    cards.push(
                        { title: 'Personal Data', icon: 'person', view: 'viewPersonal', color: 'info' },
                        { title: 'Group Data', icon: 'people-fill', view: 'viewAll', color: 'primary' }
                    );
                } else if (user.role === 'Member') {
                    cards.push(
                        { title: 'Personal Data', icon: 'person', view: 'viewPersonal', color: 'info' },
                        { title: 'Group Data', icon: 'people-fill', view: 'viewAll', color: 'primary' }
                    );
                }
                
                return cards;
            };
            
            return (
                <div className="animate-fadeInUp">
                    <div className="user-welcome">
                        <div className="d-flex justify-content-between align-items-center">
                            <div>
                                <h4>Welcome back, {user.name}!</h4>
                                <p className="mb-0">You are logged in as <span className="badge bg-success">{user.role}</span></p>
                            </div>
                            <div className="text-end">
                                <small className="text-light opacity-75">
                                    <i className="bi bi-clock-history me-1"></i>
                                    Last login: {new Date().toLocaleDateString()}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <h2 className="mb-4">Dashboard</h2>
                    
                    <div className="dashboard-grid">
                        {getDashboardCards().map((card, index) => (
                            <div key={index} className="dashboard-card" onClick={() => setView(card.view)}>
                                <div className={`dashboard-icon bg-${card.color}`}>
                                    <i className={`bi bi-${card.icon}`}></i>
                                </div>
                                <h5 className="card-title mb-2">{card.title}</h5>
                                <p className="text-muted small mb-0">Click to access</p>
                            </div>
                        ))}
                    </div>
                    
                    <div className="separator"></div>
                    
                    <div className="row">
                        <div className="col-md-6">
                            <div className="card">
                                <div className="card-header">
                                    <h5 className="mb-0">Quick Stats</h5>
                                </div>
                                <div className="card-body">
                                    <p className="text-muted mb-3">
                                        <i className="bi bi-info-circle me-2"></i>
                                        Access different modules using the dashboard cards above.
                                    </p>
                                    <div className="row">
                                        <div className="col-6">
                                            <div className="summary-card">
                                                <div className="subtitle">Your Role</div>
                                                <div className="amount">{user.role}</div>
                                            </div>
                                        </div>
                                        <div className="col-6">
                                            <div className="summary-card">
                                                <div className="subtitle">Access Level</div>
                                                <div className="amount">
                                                    {user.role === 'Admin' ? 'Full' : 
                                                     user.role === 'Secretary' ? 'High' : 
                                                     user.role === 'Chairman' ? 'Medium' : 'Basic'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="col-md-6">
                            <div className="card">
                                <div className="card-header">
                                    <h5 className="mb-0">System Information</h5>
                                </div>
                                <div className="card-body">
                                    <ul className="list-unstyled mb-0">
                                        <li className="mb-2">
                                            <i className="bi bi-check-circle text-success me-2"></i>
                                            Real-time data synchronization
                                        </li>
                                        <li className="mb-2">
                                            <i className="bi bi-check-circle text-success me-2"></i>
                                            Secure encrypted authentication
                                        </li>
                                        <li className="mb-2">
                                            <i className="bi bi-check-circle text-success me-2"></i>
                                            Role-based access control
                                        </li>
                                        <li className="mb-2">
                                            <i className="bi bi-check-circle text-success me-2"></i>
                                            Financial year tracking (2024-2030)
                                        </li>
                                        <li>
                                            <i className="bi bi-check-circle text-success me-2"></i>
                                            Automatic fine calculation
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // AccessDenied Component
        function AccessDenied() {
            return (
                <div className="text-center py-5">
                    <div className="card border-danger">
                        <div className="card-body py-5">
                            <i className="bi bi-shield-lock text-danger" style={{fontSize: '4rem'}}></i>
                            <h3 className="mt-4 text-danger">Access Denied</h3>
                            <p className="text-muted mb-4">
                                You don't have permission to access this section.
                            </p>
                            <button className="btn btn-primary" onClick={() => window.location.reload()}>
                                <i className="bi bi-arrow-left me-2"></i>
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // AddMember Component
        function AddMember({ onSuccess }) {
            const [name, setName] = useState('');
            const [role, setRole] = useState('Member');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (!name || !password) {
                        throw new Error('Please fill all required fields');
                    }
                    await addData('users', {
                        name,
                        role,
                        password: sha256(password),
                        timestamp: new Date().toISOString()
                    });
                    setName('');
                    setRole('Member');
                    setPassword('');
                    if (onSuccess) onSuccess();
                } catch (e) {
                    setError(e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Add New Member</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Member Details</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <form onSubmit={handleSubmit}>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Full Name *</label>
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            value={name} 
                                            onChange={e => setName(e.target.value)} 
                                            required 
                                            placeholder="Enter member's full name"
                                        />
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Role *</label>
                                        <select 
                                            className="form-select" 
                                            value={role} 
                                            onChange={e => setRole(e.target.value)} 
                                            required
                                        >
                                            <option value="Member">Member</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Secretary">Secretary</option>
                                            <option value="Chairman">Chairman</option>
                                            <option value="Treasurer">Treasurer</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="form-label">Password *</label>
                                    <input 
                                        type="password" 
                                        className="form-control" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)} 
                                        required 
                                        placeholder="Set login password"
                                    />
                                    <small className="text-muted">Password will be encrypted for security</small>
                                </div>
                                <div className="action-buttons">
                                    <button type="submit" className="btn btn-primary" disabled={loading}>
                                        <i className="bi bi-person-plus me-2"></i>
                                        {loading ? 'Adding Member...' : 'Add Member'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={() => window.location.reload()}>
                                        <i className="bi bi-arrow-left me-2"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // BatchAddMembers Component
        function BatchAddMembers({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [preview, setPreview] = useState([]);

            const handleFileUpload = (e) => {
                const uploaded = e.target.files[0];
                if (!uploaded) return;
                
                setFile(uploaded);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const required = ['name', 'role', 'password'];
                        const hasRequired = required.every(col => 
                            jsonData.length > 0 && col in jsonData[0]
                        );
                        
                        if (!hasRequired) {
                            throw new Error('Excel must contain columns: name, role, password');
                        }
                        
                        setPreview(jsonData.slice(0, 5));
                    } catch (e) {
                        setError('Invalid Excel file: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                        setFile(null);
                    }
                };
                reader.readAsArrayBuffer(uploaded);
            };

            const handleSubmit = async () => {
                if (!file) {
                    setError('Please select a file first');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                
                setLoading(true);
                setError('');
                try {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    const processed = jsonData.map(row => ({
                        name: row.name,
                        role: row.role || 'Member',
                        password: sha256(row.password || '123456'),
                        timestamp: new Date().toISOString()
                    })).filter(row => row.name);
                    
                    if (processed.length === 0) {
                        throw new Error('No valid member records found in file');
                    }
                    
                    await saveData('users', processed);
                    
                    if (onSuccess) onSuccess();
                    setFile(null);
                    setPreview([]);
                } catch (e) {
                    setError('Error processing file: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Batch Upload Members</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Upload Excel File with Members</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="form-label">Upload Excel File</label>
                                <input 
                                    type="file" 
                                    className="form-control" 
                                    accept=".xlsx,.xls" 
                                    onChange={handleFileUpload}
                                    disabled={loading}
                                />
                                <small className="text-muted">
                                    File must have columns: name, role, password
                                </small>
                            </div>
                            
                            {preview.length > 0 && (
                                <div className="mb-4">
                                    <h6>File Preview (first 5 rows)</h6>
                                    <div className="table-responsive">
                                        <table className="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Role</th>
                                                    <th>Password (hashed)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {preview.map((row, i) => (
                                                    <tr key={i}>
                                                        <td>{row.name}</td>
                                                        <td>{row.role || 'Member'}</td>
                                                        <td>
                                                            <small className="text-muted">
                                                                {sha256(row.password || '123456').substring(0, 10)}...
                                                            </small>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSubmit}
                                    disabled={!file || loading}
                                >
                                    <i className="bi bi-upload me-2"></i>
                                    {loading ? 'Uploading...' : 'Upload Members'}
                                </button>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Cancel
                                </button>
                            </div>
                            
                            <div className="mt-4">
                                <div className="alert alert-info">
                                    <h6><i className="bi bi-info-circle me-2"></i>Instructions</h6>
                                    <ul className="mb-0">
                                        <li>Download the template <a href="#" onClick={(e) => {
                                            e.preventDefault();
                                            const ws = XLSX.utils.aoa_to_sheet([
                                                ['name', 'role', 'password'],
                                                ['John Doe', 'Member', 'password123'],
                                                ['Jane Smith', 'Secretary', 'securepass']
                                            ]);
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, 'Members');
                                            XLSX.writeFile(wb, 'member_template.xlsx');
                                        }} className="text-primary">here</a></li>
                                        <li>Role options: Member, Admin, Secretary, Chairman, Treasurer</li>
                                        <li>Password will be hashed for security</li>
                                        <li>Member names must be unique</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ViewMembers Component
        function ViewMembers({ onRemoveSuccess, onEditSuccess }) {
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [selectedMembers, setSelectedMembers] = useState([]);
            const [editMember, setEditMember] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                loadMembers();
            }, []);

            const loadMembers = async () => {
                setLoading(true);
                try {
                    const data = await loadData('users', []);
                    setMembers(data.filter(m => m.name !== 'admin'));
                } catch (e) {
                    setError('Error loading members: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedMembers(members.map(m => m.id));
                } else {
                    setSelectedMembers([]);
                }
            };

            const handleSelectMember = (id) => {
                setSelectedMembers(prev => 
                    prev.includes(id) 
                        ? prev.filter(mid => mid !== id)
                        : [...prev, id]
                );
            };

            const handleDeleteSelected = async () => {
                if (selectedMembers.length === 0 || !confirm('Are you sure you want to delete selected members?')) return;
                
                setLoading(true);
                try {
                    await deleteByIds('users', selectedMembers);
                    await loadMembers();
                    setSelectedMembers([]);
                    if (onRemoveSuccess) onRemoveSuccess();
                } catch (e) {
                    setError('Error deleting members: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const handleUpdateMember = async (e) => {
                e.preventDefault();
                if (!editMember) return;
                
                setLoading(true);
                try {
                    await updateData('users', editMember.id, {
                        name: editMember.name,
                        role: editMember.role
                    });
                    await loadMembers();
                    setEditMember(null);
                    if (onEditSuccess) onEditSuccess();
                } catch (e) {
                    setError('Error updating member: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const filteredMembers = members.filter(member =>
                member.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                member.role.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (loading) return <div className="loading">Loading members...</div>;

            return (
                <div className="animate-fadeInUp">
                    <h2>Manage Members</h2>
                    
                    {error && (
                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                            {error}
                            <button type="button" className="btn-close" onClick={() => setError('')}></button>
                        </div>
                    )}
                    
                    <div className="card mb-4">
                        <div className="card-header">
                            <h5 className="mb-0">Member List ({filteredMembers.length} members)</h5>
                        </div>
                        <div className="card-body">
                            <div className="mb-4">
                                <div className="row">
                                    <div className="col-md-6">
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            placeholder="Search by name or role..." 
                                            value={searchTerm} 
                                            onChange={e => setSearchTerm(e.target.value)} 
                                        />
                                    </div>
                                    <div className="col-md-6">
                                        <div className="d-flex gap-2 justify-content-end">
                                            {selectedMembers.length > 0 && (
                                                <button 
                                                    className="btn btn-danger"
                                                    onClick={handleDeleteSelected}
                                                >
                                                    <i className="bi bi-trash me-2"></i>
                                                    Delete Selected ({selectedMembers.length})
                                                </button>
                                            )}
                                            <button 
                                                className="btn btn-secondary"
                                                onClick={loadMembers}
                                            >
                                                <i className="bi bi-arrow-clockwise me-2"></i>
                                                Refresh
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="table-responsive">
                                <table className="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedMembers.length === filteredMembers.length && filteredMembers.length > 0}
                                                    onChange={handleSelectAll}
                                                />
                                            </th>
                                            <th>Name</th>
                                            <th>Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredMembers.map(member => (
                                            <tr key={member.id}>
                                                <td>
                                                    <input 
                                                        type="checkbox" 
                                                        checked={selectedMembers.includes(member.id)}
                                                        onChange={() => handleSelectMember(member.id)}
                                                    />
                                                </td>
                                                <td>
                                                    {editMember?.id === member.id ? (
                                                        <input 
                                                            type="text" 
                                                            className="form-control form-control-sm" 
                                                            value={editMember.name}
                                                            onChange={e => setEditMember({...editMember, name: e.target.value})}
                                                        />
                                                    ) : (
                                                        <strong>{member.name}</strong>
                                                    )}
                                                </td>
                                                <td>
                                                    {editMember?.id === member.id ? (
                                                        <select 
                                                            className="form-select form-select-sm" 
                                                            value={editMember.role}
                                                            onChange={e => setEditMember({...editMember, role: e.target.value})}
                                                        >
                                                            <option value="Member">Member</option>
                                                            <option value="Admin">Admin</option>
                                                            <option value="Secretary">Secretary</option>
                                                            <option value="Chairman">Chairman</option>
                                                            <option value="Treasurer">Treasurer</option>
                                                        </select>
                                                    ) : (
                                                        <span className={`badge ${
                                                            member.role === 'Admin' ? 'bg-danger' :
                                                            member.role === 'Secretary' ? 'bg-primary' :
                                                            member.role === 'Chairman' ? 'bg-warning' :
                                                            member.role === 'Treasurer' ? 'bg-info' : 'bg-secondary'
                                                        }`}>
                                                            {member.role}
                                                        </span>
                                                    )}
                                                </td>
                                                <td>
                                                    {editMember?.id === member.id ? (
                                                        <div className="d-flex gap-2">
                                                            <button 
                                                                className="btn btn-success btn-sm"
                                                                onClick={handleUpdateMember}
                                                            >
                                                                <i className="bi bi-check"></i>
                                                            </button>
                                                            <button 
                                                                className="btn btn-secondary btn-sm"
                                                                onClick={() => setEditMember(null)}
                                                            >
                                                                <i className="bi bi-x"></i>
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="d-flex gap-2">
                                                            <button 
                                                                className="btn btn-warning btn-sm"
                                                                onClick={() => setEditMember({...member})}
                                                            >
                                                                <i className="bi bi-pencil"></i>
                                                            </button>
                                                            <button 
                                                                className="btn btn-danger btn-sm"
                                                                onClick={() => {
                                                                    if (confirm(`Delete ${member.name}?`)) {
                                                                        handleSelectMember(member.id);
                                                                        setTimeout(handleDeleteSelected, 100);
                                                                    }
                                                                }}
                                                            >
                                                                <i className="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {filteredMembers.length === 0 && (
                                <div className="text-center py-4">
                                    <i className="bi bi-people display-4 text-muted mb-3"></i>
                                    <p className="text-muted">No members found</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="action-buttons">
                        <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                            <i className="bi bi-arrow-left me-2"></i>
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // AddPayment Component
        function AddPayment({ onSuccess }) {
            const [date, setDate] = useState('');
            const [member, setMember] = useState('');
            const [paidIn, setPaidIn] = useState('');
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                loadData('users', []).then(data => {
                    setMembers(data.filter(u => u.role !== 'Admin').map(u => u.name));
                });
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (!date || !member || !paidIn || parseFloat(paidIn) <= 0) {
                        throw new Error('Please fill all required fields with valid values');
                    }
                    await addData('payments', {
                        date,
                        member,
                        paidIn: parseFloat(paidIn),
                        timestamp: new Date().toISOString()
                    });
                    setDate('');
                    setMember('');
                    setPaidIn('');
                    if (onSuccess) onSuccess();
                } catch (e) {
                    setError(e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Record Payment</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Add New Payment</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <form onSubmit={handleSubmit}>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Date *</label>
                                        <input 
                                            type="date" 
                                            className="form-control" 
                                            value={date} 
                                            onChange={e => setDate(e.target.value)} 
                                            required 
                                            max={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Member *</label>
                                        <select 
                                            className="form-select" 
                                            value={member} 
                                            onChange={e => setMember(e.target.value)} 
                                            required
                                        >
                                            <option value="">Select Member</option>
                                            {members.map(name => (
                                                <option key={name} value={name}>{name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="form-label">Amount Paid (KES) *</label>
                                    <input 
                                        type="number" 
                                        className="form-control" 
                                        value={paidIn} 
                                        onChange={e => setPaidIn(e.target.value)} 
                                        required 
                                        min="0.01"
                                        step="0.01"
                                        placeholder="Enter amount"
                                    />
                                    <small className="text-muted">Minimum monthly contribution: 300 KES</small>
                                </div>
                                <div className="action-buttons">
                                    <button type="submit" className="btn btn-primary" disabled={loading}>
                                        <i className="bi bi-save me-2"></i>
                                        {loading ? 'Saving...' : 'Save Payment'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={() => window.location.reload()}>
                                        <i className="bi bi-arrow-left me-2"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // BatchAddPayments Component
        function BatchAddPayments({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [preview, setPreview] = useState([]);

            const handleFileUpload = (e) => {
                const uploaded = e.target.files[0];
                if (!uploaded) return;
                
                setFile(uploaded);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const required = ['date', 'member', 'paidIn'];
                        const hasRequired = required.every(col => 
                            jsonData.length > 0 && col in jsonData[0]
                        );
                        
                        if (!hasRequired) {
                            throw new Error('Excel must contain columns: date, member, paidIn');
                        }
                        
                        setPreview(jsonData.slice(0, 5));
                    } catch (e) {
                        setError('Invalid Excel file: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                        setFile(null);
                    }
                };
                reader.readAsArrayBuffer(uploaded);
            };

            const handleSubmit = async () => {
                if (!file) {
                    setError('Please select a file first');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                
                setLoading(true);
                setError('');
                try {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    const processed = jsonData.map(row => ({
                        date: row.date,
                        member: row.member,
                        paidIn: parseFloat(row.paidIn),
                        timestamp: new Date().toISOString()
                    })).filter(row => 
                        row.date && row.member && !isNaN(row.paidIn) && row.paidIn > 0
                    );
                    
                    if (processed.length === 0) {
                        throw new Error('No valid payment records found in file');
                    }
                    
                    await saveData('payments', processed);
                    
                    if (onSuccess) onSuccess();
                    setFile(null);
                    setPreview([]);
                } catch (e) {
                    setError('Error processing file: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Batch Upload Payments</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Upload Excel File with Payments</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="form-label">Upload Excel File</label>
                                <input 
                                    type="file" 
                                    className="form-control" 
                                    accept=".xlsx,.xls" 
                                    onChange={handleFileUpload}
                                    disabled={loading}
                                />
                                <small className="text-muted">
                                    File must have columns: date, member, paidIn
                                </small>
                            </div>
                            
                            {preview.length > 0 && (
                                <div className="mb-4">
                                    <h6>File Preview (first 5 rows)</h6>
                                    <div className="table-responsive">
                                        <table className="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Member</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {preview.map((row, i) => (
                                                    <tr key={i}>
                                                        <td>{row.date}</td>
                                                        <td>{row.member}</td>
                                                        <td>{parseFloat(row.paidIn).toFixed(2)} KES</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSubmit}
                                    disabled={!file || loading}
                                >
                                    <i className="bi bi-upload me-2"></i>
                                    {loading ? 'Uploading...' : 'Upload Payments'}
                                </button>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Cancel
                                </button>
                            </div>
                            
                            <div className="mt-4">
                                <div className="alert alert-info">
                                    <h6><i className="bi bi-info-circle me-2"></i>Instructions</h6>
                                    <ul className="mb-0">
                                        <li>Download the template <a href="#" onClick={(e) => {
                                            e.preventDefault();
                                            const ws = XLSX.utils.aoa_to_sheet([
                                                ['date', 'member', 'paidIn'],
                                                ['2024-01-15', 'John Doe', '500'],
                                                ['2024-01-20', 'Jane Smith', '300']
                                            ]);
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, 'Payments');
                                            XLSX.writeFile(wb, 'payment_template.xlsx');
                                        }} className="text-primary">here</a></li>
                                        <li>Date format: YYYY-MM-DD</li>
                                        <li>Member names must match existing members</li>
                                        <li>Amount must be a positive number</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // AddLoan Component
        function AddLoan({ onSuccess }) {
            const [date, setDate] = useState('');
            const [member, setMember] = useState('');
            const [amount, setAmount] = useState('');
            const [purpose, setPurpose] = useState('');
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                loadData('users', []).then(data => {
                    setMembers(data.filter(u => u.role !== 'Admin').map(u => u.name));
                });
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (!date || !member || !amount || parseFloat(amount) <= 0) {
                        throw new Error('Please fill all required fields with valid values');
                    }
                    await addData('loans', {
                        date,
                        member,
                        amount: parseFloat(amount),
                        purpose: purpose || '',
                        interest: parseFloat(amount) * 0.1,
                        timestamp: new Date().toISOString()
                    });
                    setDate('');
                    setMember('');
                    setAmount('');
                    setPurpose('');
                    if (onSuccess) onSuccess();
                } catch (e) {
                    setError(e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Record Loan</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Add New Loan</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <form onSubmit={handleSubmit}>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Date *</label>
                                        <input 
                                            type="date" 
                                            className="form-control" 
                                            value={date} 
                                            onChange={e => setDate(e.target.value)} 
                                            required 
                                            max={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Member *</label>
                                        <select 
                                            className="form-select" 
                                            value={member} 
                                            onChange={e => setMember(e.target.value)} 
                                            required
                                        >
                                            <option value="">Select Member</option>
                                            {members.map(name => (
                                                <option key={name} value={name}>{name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Amount (KES) *</label>
                                        <input 
                                            type="number" 
                                            className="form-control" 
                                            value={amount} 
                                            onChange={e => setAmount(e.target.value)} 
                                            required 
                                            min="0.01"
                                            step="0.01"
                                            placeholder="Enter loan amount"
                                        />
                                        <small className="text-muted">10% interest will be applied automatically</small>
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Purpose (Optional)</label>
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            value={purpose} 
                                            onChange={e => setPurpose(e.target.value)} 
                                            placeholder="Loan purpose"
                                        />
                                    </div>
                                </div>
                                <div className="alert alert-warning">
                                    <i className="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Note:</strong> This loan will incur 10% interest ({parseFloat(amount || 0) * 0.1} KES)
                                </div>
                                <div className="action-buttons">
                                    <button type="submit" className="btn btn-primary" disabled={loading}>
                                        <i className="bi bi-save me-2"></i>
                                        {loading ? 'Saving...' : 'Save Loan'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={() => window.location.reload()}>
                                        <i className="bi bi-arrow-left me-2"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // BatchAddLoans Component
        function BatchAddLoans({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [preview, setPreview] = useState([]);

            const handleFileUpload = (e) => {
                const uploaded = e.target.files[0];
                if (!uploaded) return;
                
                setFile(uploaded);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const required = ['date', 'member', 'amount'];
                        const hasRequired = required.every(col => 
                            jsonData.length > 0 && col in jsonData[0]
                        );
                        
                        if (!hasRequired) {
                            throw new Error('Excel must contain columns: date, member, amount');
                        }
                        
                        setPreview(jsonData.slice(0, 5));
                    } catch (e) {
                        setError('Invalid Excel file: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                        setFile(null);
                    }
                };
                reader.readAsArrayBuffer(uploaded);
            };

            const handleSubmit = async () => {
                if (!file) {
                    setError('Please select a file first');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                
                setLoading(true);
                setError('');
                try {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    const processed = jsonData.map(row => ({
                        date: row.date,
                        member: row.member,
                        amount: parseFloat(row.amount),
                        purpose: row.purpose || '',
                        interest: parseFloat(row.amount) * 0.1,
                        timestamp: new Date().toISOString()
                    })).filter(row => 
                        row.date && row.member && !isNaN(row.amount) && row.amount > 0
                    );
                    
                    if (processed.length === 0) {
                        throw new Error('No valid loan records found in file');
                    }
                    
                    await saveData('loans', processed);
                    
                    if (onSuccess) onSuccess();
                    setFile(null);
                    setPreview([]);
                } catch (e) {
                    setError('Error processing file: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Batch Upload Loans</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Upload Excel File with Loans</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="form-label">Upload Excel File</label>
                                <input 
                                    type="file" 
                                    className="form-control" 
                                    accept=".xlsx,.xls" 
                                    onChange={handleFileUpload}
                                    disabled={loading}
                                />
                                <small className="text-muted">
                                    File must have columns: date, member, amount (purpose optional)
                                </small>
                            </div>
                            
                            {preview.length > 0 && (
                                <div className="mb-4">
                                    <h6>File Preview (first 5 rows)</h6>
                                    <div className="table-responsive">
                                        <table className="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Member</th>
                                                    <th>Amount</th>
                                                    <th>Purpose</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {preview.map((row, i) => (
                                                    <tr key={i}>
                                                        <td>{row.date}</td>
                                                        <td>{row.member}</td>
                                                        <td>{parseFloat(row.amount).toFixed(2)} KES</td>
                                                        <td>{row.purpose || '-'}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSubmit}
                                    disabled={!file || loading}
                                >
                                    <i className="bi bi-upload me-2"></i>
                                    {loading ? 'Uploading...' : 'Upload Loans'}
                                </button>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Cancel
                                </button>
                            </div>
                            
                            <div className="mt-4">
                                <div className="alert alert-info">
                                    <h6><i className="bi bi-info-circle me-2"></i>Instructions</h6>
                                    <ul className="mb-0">
                                        <li>Download the template <a href="#" onClick={(e) => {
                                            e.preventDefault();
                                            const ws = XLSX.utils.aoa_to_sheet([
                                                ['date', 'member', 'amount', 'purpose'],
                                                ['2024-01-15', 'John Doe', '5000', 'Business'],
                                                ['2024-01-20', 'Jane Smith', '3000', 'Medical']
                                            ]);
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, 'Loans');
                                            XLSX.writeFile(wb, 'loan_template.xlsx');
                                        }} className="text-primary">here</a></li>
                                        <li>Date format: YYYY-MM-DD</li>
                                        <li>Member names must match existing members</li>
                                        <li>Amount must be a positive number</li>
                                        <li>10% interest will be calculated automatically</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // AddExpenditure Component
        function AddExpenditure({ onSuccess }) {
            const [date, setDate] = useState('');
            const [member, setMember] = useState('');
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                loadData('users', []).then(data => {
                    setMembers(data.filter(u => u.role !== 'Admin').map(u => u.name));
                });
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (!date || !member || !amount || parseFloat(amount) <= 0) {
                        throw new Error('Please fill all required fields with valid values');
                    }
                    await addData('expenditures', {
                        date,
                        member,
                        amount: parseFloat(amount),
                        description: description || '',
                        timestamp: new Date().toISOString()
                    });
                    setDate('');
                    setMember('');
                    setAmount('');
                    setDescription('');
                    if (onSuccess) onSuccess();
                } catch (e) {
                    setError(e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Record Expenditure</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Add New Expenditure</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <form onSubmit={handleSubmit}>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Date *</label>
                                        <input 
                                            type="date" 
                                            className="form-control" 
                                            value={date} 
                                            onChange={e => setDate(e.target.value)} 
                                            required 
                                            max={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Member *</label>
                                        <select 
                                            className="form-select" 
                                            value={member} 
                                            onChange={e => setMember(e.target.value)} 
                                            required
                                        >
                                            <option value="">Select Member</option>
                                            {members.map(name => (
                                                <option key={name} value={name}>{name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Amount (KES) *</label>
                                        <input 
                                            type="number" 
                                            className="form-control" 
                                            value={amount} 
                                            onChange={e => setAmount(e.target.value)} 
                                            required 
                                            min="0.01"
                                            step="0.01"
                                            placeholder="Enter amount"
                                        />
                                    </div>
                                    <div className="col-md-6 mb-3">
                                        <label className="form-label">Description</label>
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            value={description} 
                                            onChange={e => setDescription(e.target.value)} 
                                            placeholder="Optional description"
                                        />
                                    </div>
                                </div>
                                <div className="action-buttons">
                                    <button type="submit" className="btn btn-primary" disabled={loading}>
                                        <i className="bi bi-save me-2"></i>
                                        {loading ? 'Saving...' : 'Save Expenditure'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={() => window.location.reload()}>
                                        <i className="bi bi-arrow-left me-2"></i>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        // BatchAddExpenditures Component
        function BatchAddExpenditures({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [preview, setPreview] = useState([]);

            const handleFileUpload = (e) => {
                const uploaded = e.target.files[0];
                if (!uploaded) return;
                
                setFile(uploaded);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const required = ['date', 'member', 'amount'];
                        const hasRequired = required.every(col => 
                            jsonData.length > 0 && col in jsonData[0]
                        );
                        
                        if (!hasRequired) {
                            throw new Error('Excel must contain columns: date, member, amount');
                        }
                        
                        setPreview(jsonData.slice(0, 5));
                    } catch (e) {
                        setError('Invalid Excel file: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                        setFile(null);
                    }
                };
                reader.readAsArrayBuffer(uploaded);
            };

            const handleSubmit = async () => {
                if (!file) {
                    setError('Please select a file first');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                
                setLoading(true);
                setError('');
                try {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    const processed = jsonData.map(row => ({
                        date: row.date,
                        member: row.member,
                        amount: parseFloat(row.amount),
                        description: row.description || '',
                        timestamp: new Date().toISOString()
                    })).filter(row => 
                        row.date && row.member && !isNaN(row.amount) && row.amount > 0
                    );
                    
                    if (processed.length === 0) {
                        throw new Error('No valid expenditure records found in file');
                    }
                    
                    await saveData('expenditures', processed);
                    
                    if (onSuccess) onSuccess();
                    setFile(null);
                    setPreview([]);
                } catch (e) {
                    setError('Error processing file: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Batch Upload Expenditures</h2>
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Upload Excel File with Expenditures</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            <div className="mb-4">
                                <label className="form-label">Upload Excel File</label>
                                <input 
                                    type="file" 
                                    className="form-control" 
                                    accept=".xlsx,.xls" 
                                    onChange={handleFileUpload}
                                    disabled={loading}
                                />
                                <small className="text-muted">
                                    File must have columns: date, member, amount (description optional)
                                </small>
                            </div>
                            
                            {preview.length > 0 && (
                                <div className="mb-4">
                                    <h6>File Preview (first 5 rows)</h6>
                                    <div className="table-responsive">
                                        <table className="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Member</th>
                                                    <th>Amount</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {preview.map((row, i) => (
                                                    <tr key={i}>
                                                        <td>{row.date}</td>
                                                        <td>{row.member}</td>
                                                        <td>{parseFloat(row.amount).toFixed(2)} KES</td>
                                                        <td>{row.description || '-'}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary" 
                                    onClick={handleSubmit}
                                    disabled={!file || loading}
                                >
                                    <i className="bi bi-upload me-2"></i>
                                    {loading ? 'Uploading...' : 'Upload Expenditures'}
                                </button>
                                <button 
                                    className="btn btn-secondary" 
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Cancel
                                </button>
                            </div>
                            
                            <div className="mt-4">
                                <div className="alert alert-info">
                                    <h6><i className="bi bi-info-circle me-2"></i>Instructions</h6>
                                    <ul className="mb-0">
                                        <li>Download the template <a href="#" onClick={(e) => {
                                            e.preventDefault();
                                            const ws = XLSX.utils.aoa_to_sheet([
                                                ['date', 'member', 'amount', 'description'],
                                                ['2024-01-15', 'John Doe', '5000', 'Travel expenses'],
                                                ['2024-01-20', 'Jane Smith', '3000', 'Office supplies']
                                            ]);
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, 'Expenditures');
                                            XLSX.writeFile(wb, 'expenditure_template.xlsx');
                                        }} className="text-primary">here</a></li>
                                        <li>Date format: YYYY-MM-DD</li>
                                        <li>Amount must be a positive number</li>
                                        <li>Member names must match existing members</li>
                                        <li>Description is optional</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ViewPersonal Component
        function ViewPersonal({ userId, year, setYear }) {
            const [allPayments, setAllPayments] = useState([]);
            const [allLoans, setAllLoans] = useState([]);
            const [allExpenditures, setAllExpenditures] = useState([]);
            const [share, setShare] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('month');
            const [sortDirection, setSortDirection] = useState('asc');
            
            useEffect(() => {
                const loadDataForYear = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const [payments, loans, expenditures, shares] = await Promise.all([
                            loadData('payments', []),
                            loadData('loans', []),
                            loadData('expenditures', []),
                            computeGroupShare(year)
                        ]);
                        
                        setAllPayments(payments.filter(p => getYear(p.date) === year));
                        setAllLoans(loans.filter(l => getYear(l.date) === year));
                        setAllExpenditures(expenditures.filter(e => getYear(e.date) === year));
                        setShare(shares);
                    } catch (e) {
                        setError('Error loading data: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadDataForYear();
            }, [year]);
            
            if (loading) return <div className="loading">Loading your data...</div>;
            if (error) return <div className="alert alert-danger">{error}</div>;
            
            const userPayments = allPayments.filter(p => p.member === userId);
            const userLoans = allLoans.filter(l => l.member === userId);
            const userExpenditures = allExpenditures.filter(e => e.member === userId);
            
            const monthlyTotals = {};
            userPayments.forEach(p => {
                const month = getMonth(p.date);
                if (month >= 1 && month <= 12) {
                    monthlyTotals[month] = (monthlyTotals[month] || 0) + (parseFloat(p.paidIn) || 0);
                }
            });
            
            let totalFines = 0;
            const monthlyFines = {};
            for (let month = 1; month <= 12; month++) {
                const monthTotal = monthlyTotals[month] || 0;
                const fine = monthTotal < 300 ? 50 : 0;
                totalFines += fine;
                monthlyFines[month] = fine;
            }
            
            const totalPaid = userPayments.reduce((sum, p) => sum + (parseFloat(p.paidIn) || 0), 0);
            const totalLoan = userLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const totalLoanInterest = totalLoan * 0.1;
            const totalExpenditures = userExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const memberShare = share[userId] || 0;
            
            const net = totalPaid - totalFines - totalExpenditures + memberShare - totalLoan - totalLoanInterest;
            
            const monthlyData = MONTH_NAMES.map((name, index) => {
                const monthIndex = index + 1;
                const paid = monthlyTotals[monthIndex] || 0;
                const fine = monthlyFines[monthIndex] || 0;
                const loan = userLoans
                    .filter(l => getMonth(l.date) === monthIndex)
                    .reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const exp = userExpenditures
                    .filter(e => getMonth(e.date) === monthIndex)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const dates = userPayments
                    .filter(p => getMonth(p.date) === monthIndex)
                    .map(p => p.date.split('-')[2])
                    .join(', ');
                
                return {
                    month: name,
                    paid,
                    fine,
                    loan,
                    exp,
                    dates
                };
            });
            
            let filteredMonths = monthlyData.filter(m => 
                m.month.toLowerCase().includes(searchTerm.toLowerCase()) ||
                m.dates.includes(searchTerm)
            );
            
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            
            filteredMonths.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                
                if (sortColumn === 'month') {
                    valA = MONTH_NAMES.indexOf(a.month);
                    valB = MONTH_NAMES.indexOf(b.month);
                }
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Personal Financial Summary - {year}</h2>
                        
                        <div className="row">
                            <div className="col-lg-8">
                                <div className="card">
                                    <div className="card-header">
                                        <h5 className="mb-0">Monthly Breakdown</h5>
                                    </div>
                                    <div className="card-body">
                                        <div className="mb-4">
                                            <input 
                                                type="text" 
                                                className="form-control" 
                                                placeholder="Search by month or date..." 
                                                value={searchTerm} 
                                                onChange={e => setSearchTerm(e.target.value)} 
                                            />
                                        </div>
                                        <div className="table-responsive">
                                            <table className="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th className={`sortable ${sortColumn === 'month' ? sortDirection : ''}`} onClick={() => handleSort('month')}>
                                                            Month <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'paid' ? sortDirection : ''}`} onClick={() => handleSort('paid')}>
                                                            Contributions <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'fine' ? sortDirection : ''}`} onClick={() => handleSort('fine')}>
                                                            Fines <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'loan' ? sortDirection : ''}`} onClick={() => handleSort('loan')}>
                                                            Loans <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'exp' ? sortDirection : ''}`} onClick={() => handleSort('exp')}>
                                                            Expenses <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th>Payment Dates</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredMonths.map((m, i) => (
                                                        <tr key={i}>
                                                            <td>
                                                                <strong>{m.month}</strong>
                                                            </td>
                                                            <td className={m.paid >= 300 ? 'text-success' : 'text-danger'}>
                                                                {m.paid.toFixed(2)} KES
                                                                {m.paid < 300 && <small className="text-danger d-block">Below minimum</small>}
                                                            </td>
                                                            <td>
                                                                <span className={`badge ${m.fine > 0 ? 'bg-danger' : 'bg-success'}`}>
                                                                    {m.fine} KES
                                                                </span>
                                                            </td>
                                                            <td>{m.loan.toFixed(2)} KES</td>
                                                            <td>{m.exp.toFixed(2)} KES</td>
                                                            <td>
                                                                <small className="text-muted">{m.dates || 'No payments'}</small>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="col-lg-4">
                                <div className="card">
                                    <div className="card-header">
                                        <h5 className="mb-0">Year {year} Summary</h5>
                                    </div>
                                    <div className="card-body">
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Contributions</div>
                                            <div className="amount text-primary">{totalPaid.toFixed(2)} KES</div>
                                            <small className="text-muted">All payments made in {year}</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Fines</div>
                                            <div className="amount text-danger">{totalFines.toFixed(2)} KES</div>
                                            <small className="text-muted">Monthly fines for contributions below 300 KES</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Loans</div>
                                            <div className="amount text-warning">{totalLoan.toFixed(2)} KES</div>
                                            <small className="text-muted">Principal amount borrowed</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Loan Interest</div>
                                            <div className="amount text-warning">{totalLoanInterest.toFixed(2)} KES</div>
                                            <small className="text-muted">10% interest on loans</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Expenditures</div>
                                            <div className="amount text-danger">{totalExpenditures.toFixed(2)} KES</div>
                                            <small className="text-muted">Personal expenses deducted</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Profit Share</div>
                                            <div className="amount text-success">{memberShare.toFixed(2)} KES</div>
                                            <small className="text-muted">Share from fines and interest</small>
                                        </div>
                                        
                                        <div className="summary-card">
                                            <div className="subtitle">Net Balance</div>
                                            <div className={`amount ${net >= 0 ? 'text-success' : 'text-danger'}`}>
                                                {net.toFixed(2)} KES
                                            </div>
                                            <small className="text-muted">Final amount for {year}</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="card mt-4">
                                    <div className="card-body">
                                        <h6 className="mb-3">Financial Summary</h6>
                                        <div className="d-flex justify-content-between mb-2">
                                            <span>Total In:</span>
                                            <strong className="text-success">{totalPaid.toFixed(2)} KES</strong>
                                        </div>
                                        <div className="d-flex justify-content-between mb-2">
                                            <span>Total Deductions:</span>
                                            <strong className="text-danger">{(totalFines + totalExpenditures + totalLoan + totalLoanInterest).toFixed(2)} KES</strong>
                                        </div>
                                        <div className="d-flex justify-content-between mb-2">
                                            <span>Share Added:</span>
                                            <strong className="text-success">{memberShare.toFixed(2)} KES</strong>
                                        </div>
                                        <hr />
                                        <div className="d-flex justify-content-between">
                                            <span>Net Balance:</span>
                                            <strong className={net >= 0 ? 'text-success' : 'text-danger'}>
                                                {net.toFixed(2)} KES
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                                <i className="bi bi-arrow-left me-2"></i>
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // ViewAllData Component
        function ViewAllData({ year, setYear }) {
            const [allPayments, setAllPayments] = useState([]);
            const [allLoans, setAllLoans] = useState([]);
            const [allExpenditures, setAllExpenditures] = useState([]);
            const [users, setUsers] = useState([]);
            const [share, setShare] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('name');
            const [sortDirection, setSortDirection] = useState('asc');
            
            useEffect(() => {
                const loadDataForYear = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const [payments, loans, expenditures, userList, shares] = await Promise.all([
                            loadData('payments', []),
                            loadData('loans', []),
                            loadData('expenditures', []),
                            loadData('users', []),
                            computeGroupShare(year)
                        ]);
                        
                        setAllPayments(payments.filter(p => getYear(p.date) === year));
                        setAllLoans(loans.filter(l => getYear(l.date) === year));
                        setAllExpenditures(expenditures.filter(e => getYear(e.date) === year));
                        setUsers(userList.sort((a, b) => a.name.localeCompare(b.name)));
                        setShare(shares);
                    } catch (e) {
                        setError('Error loading group data: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadDataForYear();
            }, [year]);
            
            if (loading) return <div className="loading">Loading group data...</div>;
            if (error) return <div className="alert alert-danger">{error}</div>;
            
            const memberData = users.map(user => {
                const userPayments = allPayments.filter(p => p.member === user.name);
                const userLoans = allLoans.filter(l => l.member === user.name);
                const userExpenditures = allExpenditures.filter(e => e.member === user.name);
                
                const fines = calculateMemberFines(user.name, allPayments, year);
                
                const totalPaid = userPayments.reduce((sum, p) => sum + (parseFloat(p.paidIn) || 0), 0);
                const totalLoan = userLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const totalLoanInterest = totalLoan * 0.1;
                const totalExp = userExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const memberShare = share[user.name] || 0;
                const net = totalPaid - fines - totalExp + memberShare - totalLoan - totalLoanInterest;
                
                return { 
                    name: user.name, 
                    role: user.role,
                    totalPaid, 
                    fines, 
                    totalExp, 
                    totalLoan, 
                    totalLoanInterest, 
                    memberShare, 
                    net 
                };
            });
            
            const totalGroupFines = memberData.reduce((sum, m) => sum + m.fines, 0);
            const totalExpenditures = allExpenditures.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            const totalLoans = allLoans.reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
            const totalLoanInterest = totalLoans * 0.1;
            const totalProfit = totalGroupFines + totalLoanInterest;
            
            let filteredMemberData = memberData.filter(m => 
                m.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                m.role.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            
            filteredMemberData.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                
                if (sortColumn === 'name') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Group Financial Overview - {year}</h2>
                        
                        <div className="row">
                            <div className="col-lg-8">
                                <div className="card">
                                    <div className="card-header">
                                        <h5 className="mb-0">Member Financial Details</h5>
                                    </div>
                                    <div className="card-body">
                                        <div className="mb-4">
                                            <input 
                                                type="text" 
                                                className="form-control" 
                                                placeholder="Search by name or role..." 
                                                value={searchTerm} 
                                                onChange={e => setSearchTerm(e.target.value)} 
                                            />
                                        </div>
                                        <div className="table-responsive">
                                            <table className="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th className={`sortable ${sortColumn === 'name' ? sortDirection : ''}`} onClick={() => handleSort('name')}>
                                                            Member <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'role' ? sortDirection : ''}`} onClick={() => handleSort('role')}>
                                                            Role <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'totalPaid' ? sortDirection : ''}`} onClick={() => handleSort('totalPaid')}>
                                                            Contributions <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'fines' ? sortDirection : ''}`} onClick={() => handleSort('fines')}>
                                                            Fines <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'totalLoan' ? sortDirection : ''}`} onClick={() => handleSort('totalLoan')}>
                                                            Loans <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'memberShare' ? sortDirection : ''}`} onClick={() => handleSort('memberShare')}>
                                                            Share <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                        <th className={`sortable ${sortColumn === 'net' ? sortDirection : ''}`} onClick={() => handleSort('net')}>
                                                            Net Balance <i className="bi bi-arrow-down-up ms-1"></i>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredMemberData.map((m, i) => (
                                                        <tr key={i}>
                                                            <td>
                                                                <strong>{m.name}</strong>
                                                            </td>
                                                            <td>
                                                                <span className="badge bg-secondary">{m.role}</span>
                                                            </td>
                                                            <td>{m.totalPaid.toFixed(2)} KES</td>
                                                            <td>
                                                                <span className={`badge ${m.fines > 0 ? 'bg-danger' : 'bg-success'}`}>
                                                                    {m.fines.toFixed(2)} KES
                                                                </span>
                                                            </td>
                                                            <td>{m.totalLoan.toFixed(2)} KES</td>
                                                            <td>
                                                                <span className="badge bg-success">
                                                                    {m.memberShare.toFixed(2)} KES
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <span className={`badge ${m.net >= 0 ? 'bg-success' : 'bg-danger'}`}>
                                                                    {m.net.toFixed(2)} KES
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="col-lg-4">
                                <div className="card">
                                    <div className="card-header">
                                        <h5 className="mb-0">Group Summary - {year}</h5>
                                    </div>
                                    <div className="card-body">
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Members</div>
                                            <div className="amount text-primary">{users.length}</div>
                                            <small className="text-muted">Active members in the system</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Fines Collected</div>
                                            <div className="amount text-warning">{totalGroupFines.toFixed(2)} KES</div>
                                            <small className="text-muted">From contributions below 300 KES</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Loans Issued</div>
                                            <div className="amount text-info">{totalLoans.toFixed(2)} KES</div>
                                            <small className="text-muted">Principal amount disbursed</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Loan Interest</div>
                                            <div className="amount text-info">{totalLoanInterest.toFixed(2)} KES</div>
                                            <small className="text-muted">10% interest earned</small>
                                        </div>
                                        
                                        <div className="summary-card mb-3">
                                            <div className="subtitle">Total Expenditures</div>
                                            <div className="amount text-danger">{totalExpenditures.toFixed(2)} KES</div>
                                            <small className="text-muted">Group expenses for {year}</small>
                                        </div>
                                        
                                        <div className="summary-card">
                                            <div className="subtitle">Total Group Profit</div>
                                            <div className="amount text-success">{totalProfit.toFixed(2)} KES</div>
                                            <small className="text-muted">Fines + Loan Interest</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="card mt-4">
                                    <div className="card-body">
                                        <h6 className="mb-3">Year {year} Statistics</h6>
                                        <div className="mb-3">
                                            <div className="d-flex justify-content-between mb-1">
                                                <small>Fines Contribution</small>
                                                <small>{totalGroupFines.toFixed(2)} KES</small>
                                            </div>
                                            <div className="progress">
                                                <div 
                                                    className="progress-bar bg-warning" 
                                                    style={{ width: `${(totalGroupFines / totalProfit) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        <div className="mb-3">
                                            <div className="d-flex justify-content-between mb-1">
                                                <small>Interest Contribution</small>
                                                <small>{totalLoanInterest.toFixed(2)} KES</small>
                                            </div>
                                            <div className="progress">
                                                <div 
                                                    className="progress-bar bg-info" 
                                                    style={{ width: `${(totalLoanInterest / totalProfit) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        <div className="mt-4">
                                            <div className="row text-center">
                                                <div className="col-6">
                                                    <div className="text-muted small">Avg Contribution</div>
                                                    <div className="h5">
                                                        {(allPayments.reduce((sum, p) => sum + (parseFloat(p.paidIn) || 0), 0) / users.length).toFixed(2)} KES
                                                    </div>
                                                </div>
                                                <div className="col-6">
                                                    <div className="text-muted small">Avg Share</div>
                                                    <div className="h5">
                                                        {(Object.values(share).reduce((sum, s) => sum + s, 0) / users.length).toFixed(2)} KES
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                                <i className="bi bi-arrow-left me-2"></i>
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // MonthlySummary Component
        function MonthlySummary({ year, setYear }) {
            const [data, setData] = useState({ payments: [], loans: [], exp: [] });
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('month');
            const [sortDirection, setSortDirection] = useState('asc');
            
            useEffect(() => {
                const loadDataForYear = async () => {
                    setLoading(true);
                    try {
                        const [payments, loans, expenditures] = await Promise.all([
                            loadData('payments', []),
                            loadData('loans', []),
                            loadData('expenditures', [])
                        ]);
                        
                        setData({
                            payments: payments.filter(p => getYear(p.date) === year),
                            loans: loans.filter(l => getYear(l.date) === year),
                            exp: expenditures.filter(e => getYear(e.date) === year)
                        });
                    } catch (error) {
                        console.error('Error loading monthly data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadDataForYear();
            }, [year]);
            
            if (loading) return <div className="loading">Loading monthly data...</div>;
            
            let summary = MONTH_NAMES.map((name, i) => {
                const month = i + 1;
                const paid = data.payments
                    .filter(p => getMonth(p.date) === month)
                    .reduce((sum, p) => sum + (parseFloat(p.paidIn) || 0), 0);
                const loaned = data.loans
                    .filter(l => getMonth(l.date) === month)
                    .reduce((sum, l) => sum + (parseFloat(l.amount) || 0), 0);
                const ex = data.exp
                    .filter(e => getMonth(e.date) === month)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const profit = (loaned * 0.1);
                const fines = data.payments
                    .filter(p => getMonth(p.date) === month)
                    .reduce((sum, p) => sum + ((parseFloat(p.paidIn) || 0) < 300 ? 50 : 0), 0);
                
                return { 
                    month: name, 
                    paid, 
                    loaned, 
                    ex, 
                    profit,
                    fines,
                    totalIncome: paid + fines + (loaned * 0.1)
                };
            });
            
            summary = summary.filter(s => s.month.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const handleSort = (column) => {
                const direction = sortColumn === column && sortDirection === 'asc' ? 'desc' : 'asc';
                setSortColumn(column);
                setSortDirection(direction);
            };
            
            summary.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                
                if (sortColumn === 'month') {
                    valA = MONTH_NAMES.indexOf(a.month);
                    valB = MONTH_NAMES.indexOf(b.month);
                }
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            const yearTotals = summary.reduce((totals, month) => ({
                paid: totals.paid + month.paid,
                loaned: totals.loaned + month.loaned,
                ex: totals.ex + month.ex,
                profit: totals.profit + month.profit,
                fines: totals.fines + month.fines,
                totalIncome: totals.totalIncome + month.totalIncome
            }), { paid: 0, loaned: 0, ex: 0, profit: 0, fines: 0, totalIncome: 0 });
            
            return (
                <ErrorBoundary>
                    <div>
                        <h2>Monthly Financial Report - {year}</h2>
                        
                        <div className="row mb-4">
                            <div className="col-md-3">
                                <div className="summary-card">
                                    <div className="subtitle">Total Contributions</div>
                                    <div className="amount text-primary">{yearTotals.paid.toFixed(2)} KES</div>
                                </div>
                            </div>
                            <div className="col-md-3">
                                <div className="summary-card">
                                    <div className="subtitle">Total Loans</div>
                                    <div className="amount text-warning">{yearTotals.loaned.toFixed(2)} KES</div>
                                </div>
                            </div>
                            <div className="col-md-3">
                                <div className="summary-card">
                                    <div className="subtitle">Total Fines</div>
                                    <div className="amount text-danger">{yearTotals.fines.toFixed(2)} KES</div>
                                </div>
                            </div>
                            <div className="col-md-3">
                                <div className="summary-card">
                                    <div className="subtitle">Total Profit</div>
                                    <div className="amount text-success">{yearTotals.profit.toFixed(2)} KES</div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="card">
                            <div className="card-header">
                                <h5 className="mb-0">Monthly Breakdown</h5>
                            </div>
                            <div className="card-body">
                                <div className="mb-4">
                                    <input 
                                        type="text" 
                                        className="form-control" 
                                        placeholder="Search by month..." 
                                        value={searchTerm} 
                                        onChange={e => setSearchTerm(e.target.value)} 
                                    />
                                </div>
                                <div className="table-responsive">
                                    <table className="table table-hover">
                                        <thead>
                                            <tr>
                                                <th className={`sortable ${sortColumn === 'month' ? sortDirection : ''}`} onClick={() => handleSort('month')}>
                                                    Month <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'paid' ? sortDirection : ''}`} onClick={() => handleSort('paid')}>
                                                    Contributions <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'fines' ? sortDirection : ''}`} onClick={() => handleSort('fines')}>
                                                    Fines <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'loaned' ? sortDirection : ''}`} onClick={() => handleSort('loaned')}>
                                                    Loans <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'profit' ? sortDirection : ''}`} onClick={() => handleSort('profit')}>
                                                    Loan Interest <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'ex' ? sortDirection : ''}`} onClick={() => handleSort('ex')}>
                                                    Expenses <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                                <th className={`sortable ${sortColumn === 'totalIncome' ? sortDirection : ''}`} onClick={() => handleSort('totalIncome')}>
                                                    Total Income <i className="bi bi-arrow-down-up ms-1"></i>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {summary.map((s, i) => (
                                                <tr key={i}>
                                                    <td>
                                                        <strong>{s.month}</strong>
                                                    </td>
                                                    <td>{s.paid.toFixed(2)} KES</td>
                                                    <td>
                                                        <span className={`badge ${s.fines > 0 ? 'bg-danger' : 'bg-success'}`}>
                                                            {s.fines.toFixed(2)} KES
                                                        </span>
                                                    </td>
                                                    <td>{s.loaned.toFixed(2)} KES</td>
                                                    <td className="text-success">{s.profit.toFixed(2)} KES</td>
                                                    <td>{s.ex.toFixed(2)} KES</td>
                                                    <td>
                                                        <span className="badge bg-primary">
                                                            {s.totalIncome.toFixed(2)} KES
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            <tr className="table-active">
                                                <td><strong>Year {year} Total</strong></td>
                                                <td><strong>{yearTotals.paid.toFixed(2)} KES</strong></td>
                                                <td><strong>{yearTotals.fines.toFixed(2)} KES</strong></td>
                                                <td><strong>{yearTotals.loaned.toFixed(2)} KES</strong></td>
                                                <td><strong className="text-success">{yearTotals.profit.toFixed(2)} KES</strong></td>
                                                <td><strong>{yearTotals.ex.toFixed(2)} KES</strong></td>
                                                <td><strong className="text-primary">{yearTotals.totalIncome.toFixed(2)} KES</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-4">
                            <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                                <i className="bi bi-arrow-left me-2"></i>
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </ErrorBoundary>
            );
        }

        // ManageTransactions Component
        function ManageTransactions({ year, onDeleteSuccess, onEditSuccess }) {
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [selectedType, setSelectedType] = useState('all');
            const [selectedMember, setSelectedMember] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [editTransaction, setEditTransaction] = useState(null);
            const [members, setMembers] = useState([]);

            useEffect(() => {
                loadTransactions();
                loadData('users', []).then(data => {
                    setMembers(data.filter(u => u.role !== 'Admin').map(u => u.name));
                });
            }, [year]);

            const loadTransactions = async () => {
                setLoading(true);
                try {
                    const [payments, loans, expenditures] = await Promise.all([
                        loadData('payments', []),
                        loadData('loans', []),
                        loadData('expenditures', [])
                    ]);
                    
                    const allTransactions = [
                        ...payments.filter(p => getYear(p.date) === year).map(p => ({ ...p, type: 'payment' })),
                        ...loans.filter(l => getYear(l.date) === year).map(l => ({ ...l, type: 'loan' })),
                        ...expenditures.filter(e => getYear(e.date) === year).map(e => ({ ...e, type: 'expenditure' }))
                    ].sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    setTransactions(allTransactions);
                } catch (e) {
                    setError('Error loading transactions: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteTransaction = async (id, type) => {
                if (!confirm('Are you sure you want to delete this transaction?')) return;
                
                setLoading(true);
                try {
                    const collectionName = type === 'payment' ? 'payments' : type === 'loan' ? 'loans' : 'expenditures';
                    await deleteData(collectionName, 'timestamp', transactions.find(t => t.id === id).timestamp);
                    await loadTransactions();
                    if (onDeleteSuccess) onDeleteSuccess();
                } catch (e) {
                    setError('Error deleting transaction: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const handleUpdateTransaction = async (e) => {
                e.preventDefault();
                if (!editTransaction) return;
                
                setLoading(true);
                try {
                    const collectionName = editTransaction.type === 'payment' ? 'payments' : 
                                           editTransaction.type === 'loan' ? 'loans' : 'expenditures';
                    await updateData(collectionName, editTransaction.id, {
                        date: editTransaction.date,
                        member: editTransaction.member,
                        amount: editTransaction.type === 'payment' ? editTransaction.paidIn : editTransaction.amount,
                        ...(editTransaction.type === 'payment' ? {} : { description: editTransaction.description || '' }),
                        ...(editTransaction.type === 'loan' ? { interest: editTransaction.amount * 0.1 } : {})
                    });
                    await loadTransactions();
                    setEditTransaction(null);
                    if (onEditSuccess) onEditSuccess();
                } catch (e) {
                    setError('Error updating transaction: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const filteredTransactions = transactions.filter(t => {
                if (selectedType !== 'all' && t.type !== selectedType) return false;
                if (selectedMember !== 'all' && t.member !== selectedMember) return false;
                if (searchTerm && !t.member.toLowerCase().includes(searchTerm.toLowerCase()) && 
                    !t.date.includes(searchTerm)) return false;
                return true;
            });

            if (loading) return <div className="loading">Loading transactions...</div>;

            return (
                <div className="animate-fadeInUp">
                    <h2>Manage Transactions - {year}</h2>
                    
                    {error && (
                        <div className="alert alert-danger alert-dismissible fade show" role="alert">
                            {error}
                            <button type="button" className="btn-close" onClick={() => setError('')}></button>
                        </div>
                    )}
                    
                    <div className="card mb-4">
                        <div className="card-header">
                            <h5 className="mb-0">All Transactions ({filteredTransactions.length})</h5>
                        </div>
                        <div className="card-body">
                            <div className="row mb-4">
                                <div className="col-md-3">
                                    <select 
                                        className="form-select" 
                                        value={selectedType} 
                                        onChange={e => setSelectedType(e.target.value)}
                                    >
                                        <option value="all">All Types</option>
                                        <option value="payment">Payments</option>
                                        <option value="loan">Loans</option>
                                        <option value="expenditure">Expenditures</option>
                                    </select>
                                </div>
                                <div className="col-md-3">
                                    <select 
                                        className="form-select" 
                                        value={selectedMember} 
                                        onChange={e => setSelectedMember(e.target.value)}
                                    >
                                        <option value="all">All Members</option>
                                        {members.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="col-md-4">
                                    <input 
                                        type="text" 
                                        className="form-control" 
                                        placeholder="Search by member or date..." 
                                        value={searchTerm} 
                                        onChange={e => setSearchTerm(e.target.value)} 
                                    />
                                </div>
                                <div className="col-md-2">
                                    <button 
                                        className="btn btn-secondary w-100"
                                        onClick={loadTransactions}
                                    >
                                        <i className="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div className="table-responsive">
                                <table className="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Member</th>
                                            <th>Amount</th>
                                            <th>Details</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredTransactions.map((t, i) => (
                                            <tr key={i}>
                                                <td>
                                                    {editTransaction?.id === t.id ? (
                                                        <input 
                                                            type="date" 
                                                            className="form-control form-control-sm" 
                                                            value={editTransaction.date}
                                                            onChange={e => setEditTransaction({...editTransaction, date: e.target.value})}
                                                        />
                                                    ) : (
                                                        t.date
                                                    )}
                                                </td>
                                                <td>
                                                    <span className={`badge ${
                                                        t.type === 'payment' ? 'bg-success' :
                                                        t.type === 'loan' ? 'bg-warning' : 'bg-danger'
                                                    }`}>
                                                        {t.type}
                                                    </span>
                                                </td>
                                                <td>
                                                    {editTransaction?.id === t.id ? (
                                                        <select 
                                                            className="form-select form-select-sm" 
                                                            value={editTransaction.member}
                                                            onChange={e => setEditTransaction({...editTransaction, member: e.target.value})}
                                                        >
                                                            <option value="">Select Member</option>
                                                            {members.map(name => (
                                                                <option key={name} value={name}>{name}</option>
                                                            ))}
                                                        </select>
                                                    ) : (
                                                        t.member
                                                    )}
                                                </td>
                                                <td>
                                                    {editTransaction?.id === t.id ? (
                                                        <input 
                                                            type="number" 
                                                            className="form-control form-control-sm" 
                                                            value={editTransaction.type === 'payment' ? editTransaction.paidIn : editTransaction.amount}
                                                            onChange={e => setEditTransaction({
                                                                ...editTransaction,
                                                                ...(editTransaction.type === 'payment' ? { paidIn: e.target.value } : { amount: e.target.value })
                                                            })}
                                                        />
                                                    ) : (
                                                        <span className={`${t.type === 'payment' ? 'text-success' : 'text-danger'}`}>
                                                            {t.type === 'payment' ? t.paidIn : t.amount} KES
                                                        </span>
                                                    )}
                                                </td>
                                                <td>
                                                    {editTransaction?.id === t.id ? (
                                                        <input 
                                                            type="text" 
                                                            className="form-control form-control-sm" 
                                                            value={editTransaction.description || ''}
                                                            onChange={e => setEditTransaction({...editTransaction, description: e.target.value})}
                                                            placeholder="Description"
                                                        />
                                                    ) : (
                                                        <small className="text-muted">
                                                            {t.type === 'payment' ? 'Payment' : 
                                                             t.type === 'loan' ? `Loan: ${t.purpose || 'No purpose'}` : 
                                                             `Expense: ${t.description || 'No description'}`}
                                                        </small>
                                                    )}
                                                </td>
                                                <td>
                                                    {editTransaction?.id === t.id ? (
                                                        <div className="d-flex gap-2">
                                                            <button 
                                                                className="btn btn-success btn-sm"
                                                                onClick={handleUpdateTransaction}
                                                            >
                                                                <i className="bi bi-check"></i>
                                                            </button>
                                                            <button 
                                                                className="btn btn-secondary btn-sm"
                                                                onClick={() => setEditTransaction(null)}
                                                            >
                                                                <i className="bi bi-x"></i>
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="d-flex gap-2">
                                                            <button 
                                                                className="btn btn-warning btn-sm"
                                                                onClick={() => setEditTransaction({...t})}
                                                            >
                                                                <i className="bi bi-pencil"></i>
                                                            </button>
                                                            <button 
                                                                className="btn btn-danger btn-sm"
                                                                onClick={() => handleDeleteTransaction(t.id, t.type)}
                                                            >
                                                                <i className="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {filteredTransactions.length === 0 && (
                                <div className="text-center py-4">
                                    <i className="bi bi-receipt display-4 text-muted mb-3"></i>
                                    <p className="text-muted">No transactions found</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="action-buttons">
                        <button className="btn btn-secondary" onClick={() => window.location.reload()}>
                            <i className="bi bi-arrow-left me-2"></i>
                            Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        }

        // DownloadData Component
        function DownloadData({ year }) {
            const [data, setData] = useState({ payments: [], loans: [], exp: [], members: [] });
            const [loading, setLoading] = useState(true);
            const [selectedData, setSelectedData] = useState('all');

            useEffect(() => {
                const loadDataForDownload = async () => {
                    setLoading(true);
                    try {
                        const [payments, loans, expenditures, members] = await Promise.all([
                            loadData('payments', []),
                            loadData('loans', []),
                            loadData('expenditures', []),
                            loadData('users', [])
                        ]);
                        
                        setData({
                            payments: payments.filter(p => getYear(p.date) === year),
                            loans: loans.filter(l => getYear(l.date) === year),
                            exp: expenditures.filter(e => getYear(e.date) === year),
                            members: members.filter(m => m.name !== 'admin')
                        });
                    } catch (error) {
                        console.error('Error loading data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadDataForDownload();
            }, [year]);

            const downloadExcel = () => {
                let dataToDownload = [];
                let filename = '';
                
                switch (selectedData) {
                    case 'payments':
                        dataToDownload = data.payments.map(p => ({
                            Date: p.date,
                            Member: p.member,
                            'Amount Paid': p.paidIn,
                            'Timestamp': p.timestamp
                        }));
                        filename = `payments_${year}.xlsx`;
                        break;
                    case 'loans':
                        dataToDownload = data.loans.map(l => ({
                            Date: l.date,
                            Member: l.member,
                            Amount: l.amount,
                            Purpose: l.purpose || '',
                            Interest: l.interest || (l.amount * 0.1),
                            'Timestamp': l.timestamp
                        }));
                        filename = `loans_${year}.xlsx`;
                        break;
                    case 'expenditures':
                        dataToDownload = data.exp.map(e => ({
                            Date: e.date,
                            Member: e.member,
                            Amount: e.amount,
                            Description: e.description || '',
                            'Timestamp': e.timestamp
                        }));
                        filename = `expenditures_${year}.xlsx`;
                        break;
                    case 'members':
                        dataToDownload = data.members.map(m => ({
                            Name: m.name,
                            Role: m.role,
                            'Password Hash': m.password,
                            'Timestamp': m.timestamp
                        }));
                        filename = `members.xlsx`;
                        break;
                    case 'all':
                        const ws1 = XLSX.utils.json_to_sheet(data.payments.map(p => ({
                            Date: p.date,
                            Member: p.member,
                            'Amount Paid': p.paidIn
                        })));
                        const ws2 = XLSX.utils.json_to_sheet(data.loans.map(l => ({
                            Date: l.date,
                            Member: l.member,
                            Amount: l.amount,
                            Purpose: l.purpose || '',
                            Interest: l.interest || (l.amount * 0.1)
                        })));
                        const ws3 = XLSX.utils.json_to_sheet(data.exp.map(e => ({
                            Date: e.date,
                            Member: e.member,
                            Amount: e.amount,
                            Description: e.description || ''
                        })));
                        const ws4 = XLSX.utils.json_to_sheet(data.members.map(m => ({
                            Name: m.name,
                            Role: m.role
                        })));
                        
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws1, 'Payments');
                        XLSX.utils.book_append_sheet(wb, ws2, 'Loans');
                        XLSX.utils.book_append_sheet(wb, ws3, 'Expenditures');
                        XLSX.utils.book_append_sheet(wb, ws4, 'Members');
                        XLSX.writeFile(wb, `all_data_${year}.xlsx`);
                        return;
                }
                
                if (dataToDownload.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(dataToDownload);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Data');
                    XLSX.writeFile(wb, filename);
                }
            };

            if (loading) return <div className="loading">Loading data for download...</div>;

            return (
                <div className="animate-fadeInUp">
                    <h2>Download Data</h2>
                    
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Download Financial Data</h5>
                        </div>
                        <div className="card-body">
                            <div className="row mb-4">
                                <div className="col-md-6">
                                    <label className="form-label">Select Data Type</label>
                                    <select 
                                        className="form-select" 
                                        value={selectedData} 
                                        onChange={e => setSelectedData(e.target.value)}
                                    >
                                        <option value="all">All Data (Multiple Sheets)</option>
                                        <option value="payments">Payments Only</option>
                                        <option value="loans">Loans Only</option>
                                        <option value="expenditures">Expenditures Only</option>
                                        <option value="members">Members List</option>
                                    </select>
                                </div>
                                <div className="col-md-6">
                                    <label className="form-label">Year</label>
                                    <select 
                                        className="form-select" 
                                        value={year} 
                                        onChange={e => {}}
                                        disabled
                                    >
                                        <option value={year}>{year}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="row mb-4">
                                <div className="col-md-3">
                                    <div className="summary-card">
                                        <div className="subtitle">Payments</div>
                                        <div className="amount">{data.payments.length}</div>
                                    </div>
                                </div>
                                <div className="col-md-3">
                                    <div className="summary-card">
                                        <div className="subtitle">Loans</div>
                                        <div className="amount">{data.loans.length}</div>
                                    </div>
                                </div>
                                <div className="col-md-3">
                                    <div className="summary-card">
                                        <div className="subtitle">Expenditures</div>
                                        <div className="amount">{data.exp.length}</div>
                                    </div>
                                </div>
                                <div className="col-md-3">
                                    <div className="summary-card">
                                        <div className="subtitle">Members</div>
                                        <div className="amount">{data.members.length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="alert alert-info">
                                <i className="bi bi-info-circle me-2"></i>
                                <strong>Note:</strong> Downloaded data will be in Excel format. 
                                {selectedData === 'all' && ' Multiple sheets will be created for each data type.'}
                            </div>
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary"
                                    onClick={downloadExcel}
                                    disabled={loading}
                                >
                                    <i className="bi bi-cloud-download me-2"></i>
                                    Download {selectedData === 'all' ? 'All Data' : selectedData}
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Back to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // UploadData Component
        function UploadData({ onSuccess }) {
            const [file, setFile] = useState(null);
            const [dataType, setDataType] = useState('payments');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [preview, setPreview] = useState([]);

            const handleFileUpload = (e) => {
                const uploaded = e.target.files[0];
                if (!uploaded) return;
                
                setFile(uploaded);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        setPreview(jsonData.slice(0, 5));
                    } catch (e) {
                        setError('Invalid Excel file: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                        setFile(null);
                    }
                };
                reader.readAsArrayBuffer(uploaded);
            };

            const handleSubmit = async () => {
                if (!file) {
                    setError('Please select a file first');
                    setTimeout(() => setError(''), 3000);
                    return;
                }
                
                setLoading(true);
                setError('');
                try {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    let processed = [];
                    const collectionName = dataType === 'payments' ? 'payments' : 
                                          dataType === 'loans' ? 'loans' : 
                                          dataType === 'expenditures' ? 'expenditures' : 'users';
                    
                    switch (dataType) {
                        case 'payments':
                            processed = jsonData.map(row => ({
                                date: row.date,
                                member: row.member,
                                paidIn: parseFloat(row.paidIn),
                                timestamp: new Date().toISOString()
                            })).filter(row => row.date && row.member && !isNaN(row.paidIn) && row.paidIn > 0);
                            break;
                        case 'loans':
                            processed = jsonData.map(row => ({
                                date: row.date,
                                member: row.member,
                                amount: parseFloat(row.amount),
                                purpose: row.purpose || '',
                                interest: parseFloat(row.amount) * 0.1,
                                timestamp: new Date().toISOString()
                            })).filter(row => row.date && row.member && !isNaN(row.amount) && row.amount > 0);
                            break;
                        case 'expenditures':
                            processed = jsonData.map(row => ({
                                date: row.date,
                                member: row.member,
                                amount: parseFloat(row.amount),
                                description: row.description || '',
                                timestamp: new Date().toISOString()
                            })).filter(row => row.date && row.member && !isNaN(row.amount) && row.amount > 0);
                            break;
                        case 'members':
                            processed = jsonData.map(row => ({
                                name: row.name,
                                role: row.role || 'Member',
                                password: sha256(row.password || '123456'),
                                timestamp: new Date().toISOString()
                            })).filter(row => row.name);
                            break;
                    }
                    
                    if (processed.length === 0) {
                        throw new Error('No valid records found in file');
                    }
                    
                    await saveData(collectionName, processed);
                    
                    if (onSuccess) onSuccess();
                    setFile(null);
                    setPreview([]);
                } catch (e) {
                    setError('Error processing file: ' + e.message);
                    setTimeout(() => setError(''), 3000);
                } finally {
                    setLoading(false);
                }
            };

            const getRequiredColumns = () => {
                switch (dataType) {
                    case 'payments': return 'date, member, paidIn';
                    case 'loans': return 'date, member, amount (purpose optional)';
                    case 'expenditures': return 'date, member, amount (description optional)';
                    case 'members': return 'name, role, password';
                    default: return '';
                }
            };

            return (
                <div className="animate-fadeInUp">
                    <h2>Upload Data</h2>
                    
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">Upload Data from Excel</h5>
                        </div>
                        <div className="card-body">
                            {error && (
                                <div className="alert alert-danger alert-dismissible fade show" role="alert">
                                    {error}
                                    <button type="button" className="btn-close" onClick={() => setError('')}></button>
                                </div>
                            )}
                            
                            <div className="row mb-4">
                                <div className="col-md-6">
                                    <label className="form-label">Data Type</label>
                                    <select 
                                        className="form-select" 
                                        value={dataType} 
                                        onChange={e => setDataType(e.target.value)}
                                        disabled={loading}
                                    >
                                        <option value="payments">Payments</option>
                                        <option value="loans">Loans</option>
                                        <option value="expenditures">Expenditures</option>
                                        <option value="members">Members</option>
                                    </select>
                                </div>
                                <div className="col-md-6">
                                    <label className="form-label">Excel File</label>
                                    <input 
                                        type="file" 
                                        className="form-control" 
                                        accept=".xlsx,.xls" 
                                        onChange={handleFileUpload}
                                        disabled={loading}
                                    />
                                </div>
                            </div>
                            
                            <div className="alert alert-info mb-4">
                                <i className="bi bi-info-circle me-2"></i>
                                Required columns: <strong>{getRequiredColumns()}</strong>
                            </div>
                            
                            {preview.length > 0 && (
                                <div className="mb-4">
                                    <h6>File Preview (first 5 rows)</h6>
                                    <div className="table-responsive">
                                        <table className="table table-sm">
                                            <thead>
                                                <tr>
                                                    {Object.keys(preview[0]).map(key => (
                                                        <th key={key}>{key}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {preview.map((row, i) => (
                                                    <tr key={i}>
                                                        {Object.values(row).map((val, j) => (
                                                            <td key={j}>{val}</td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            
                            <div className="action-buttons">
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleSubmit}
                                    disabled={!file || loading}
                                >
                                    <i className="bi bi-upload me-2"></i>
                                    {loading ? 'Uploading...' : `Upload ${dataType}`}
                                </button>
                                <button 
                                    className="btn btn-secondary"
                                    onClick={() => window.location.reload()}
                                >
                                    <i className="bi bi-arrow-left me-2"></i>
                                    Back to Dashboard
                                </button>
                            </div>
                            
                            <div className="mt-4">
                                <div className="alert alert-warning">
                                    <h6><i className="bi bi-exclamation-triangle me-2"></i>Important Notes</h6>
                                    <ul className="mb-0">
                                        <li>Make sure data format matches the required columns</li>
                                        <li>Date format must be YYYY-MM-DD</li>
                                        <li>Member names must match existing members (except when uploading members)</li>
                                        <li>All data will be added to the current year</li>
                                        <li>Existing data will not be overwritten</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            
            useEffect(() => {
                const initializeAdmin = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const users = await loadData('users', []);
                        if (!users || users.length === 0) {
                            await addData('users', { 
                                name: 'admin', 
                                role: 'Admin', 
                                password: sha256('Ghost123') 
                            });
                        }
                        const storedUser = sessionStorage.getItem('user');
                        if (storedUser) {
                            try {
                                setUser(JSON.parse(storedUser));
                            } catch (e) {
                                console.error('Invalid session user', e);
                                sessionStorage.removeItem('user');
                            }
                        }
                    } catch (e) {
                        setError('Error initializing app: ' + e.message);
                        setTimeout(() => setError(''), 3000);
                    } finally {
                        setLoading(false);
                    }
                };
                initializeAdmin();
            }, []);
            
            const handleLogin = (userData) => {
                sessionStorage.setItem('user', JSON.stringify(userData));
                setUser(userData);
            };
            
            const handleLogout = () => {
                sessionStorage.removeItem('user');
                setUser(null);
            };
            
            if (error) return <div className="alert alert-danger">{error}</div>;
            if (loading) return <div className="loading">Initializing application...</div>;
            
            return (
                <DatabaseInitializer>
                    <ErrorBoundary>
                        {user ? <Dashboard user={user} onLogout={handleLogout} /> : <Login onLogin={handleLogin} />}
                    </ErrorBoundary>
                </DatabaseInitializer>
            );
        }

        // Render (React 18)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>